(function(e,t){if("function"==typeof define&&define.amd)define(["locallyjs","backbone","underscore"],t);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore"),o=require("locallyjs");module.exports=t(o,i,r)}else t(e.Locally,e.Backbone,e._)})(this,function(e,t,i){"use strict";function r(e,t,i,r){if(o(i,r)){var s=t.mode;s&&(e._fetched[s]=!1),e.trigger("outdated",e,i,t)}}function o(e,t){return i.isUndefined(e)?!1:i.isUndefined(t)?!0:e!==t}function s(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function c(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}var n,d={backboneSync:t.sync,modes:function(){return i.keys(a)},register:function(e,t){i.isObject(e)?i.extend(a,e):a[e]=t},unregister:function(e){delete a[e]},mode:function(e){return i.isFunction(e)?e:a[e]},defaultMode:function(e){return e?(n=i.isFunction(e)?i.findKey(a,function(t){return t===e}):e,void 0):n},reset:function(){a={}},VERSION:"0.1.0"},a={};t.Repository=d,function(e,t){e.Jsonify={},e.Jsonify.VERSION="0.2.0",e.Jsonify.exToJSON=e.Model.prototype.toJSON;var i=function(r,o){return t.each(r,function(s,c){s instanceof e.Model||s instanceof e.Collection?r[c]=s.toJSON({deepJson:o}):t.isObject(s)&&o&&(r[c]=i(t.clone(s),o))}),r};e.Model.prototype.exToJSON=e.Jsonify.exToJSON,e.Model.prototype.toJSON=t.wrap(e.Jsonify.exToJSON,function(e){var r=arguments[1];r||(r={});var o;return t.isBoolean(r.omit)&&r.omit||t.isBoolean(r.pick)&&!r.pick?{}:(o=t.isBoolean(r.pick)&&r.pick||t.isBoolean(r.omit)&&!r.omit?e.call(this,r):r.pick?t.pick(this.attributes,r.pick):r.omit?t.omit(this.attributes,r.omit):e.call(this,r),o=i(o,r.deepJson))})}(t,i);var l=t.Model,u=t.Model.prototype.set,h=t.Model.prototype.fetch,f=t.Model.prototype.save,p=t.Model.prototype.destroy,y=t.Model.prototype.toJSON;t.Model=t.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==t.Model.prototype.initialize){var e=this,r=this.initialize;this.initialize=i.wrap(t.Model.prototype.initialize,function(t){t.apply(e,i.rest(arguments)),r.apply(e,i.rest(arguments))})}return l.apply(this,arguments)},initialize:function(){this._fetched={},this.dirtied={},i.each(t.Repository.modes(),function(e){this.dirtied[e]={}}.bind(this)),this._dirtyDestroyed=!1,this._destroyed={},i.each(t.Repository.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),i.extend(this.dirtied[e],i.omit(this.attributes,[this.idAttribute,this.cidAttribute]))}.bind(this)),this.set(this.cidAttribute,this.cid);var e=this.constructor;e.register().add(this)},versionAttribute:!1,_fetched:{},isFetched:function(e){return e||(e={}),i.defaults(e,{mode:d.defaultMode()}),this._fetched[e.mode]||!1},dirtied:{},dirtiedAttributes:function(e){return e||(e={}),i.defaults(e,{mode:d.defaultMode()}),i.clone(this.dirtied[e.mode])||{}},hasDirtied:function(e,t){return t||(t={}),i.defaults(t,{mode:d.defaultMode()}),null==e?!i.isEmpty(this.dirtied[t.mode]):i.has(this.dirtied[t.mode],e)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){i.each(this.dirtied,function(e,t){this.dirtied[t]={}}.bind(this)),this.dirtiedDestroyed=!1},set:function(e,o,s){if(null==e)return this;var c;"object"==typeof e?(c=e,s=o):(c={})[e]=o,s||(s={}),i.isUndefined(s.dirty)&&(s.dirty=!0);var n;s.version&&(n=this.attributes[this.versionAttribute]);var d=u.call(this,c,s);if(s.dirty&&i.each(t.Repository.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),i.extend(this.dirtied[e],i.omit(c,[this.idAttribute,this.cidAttribute]))}.bind(this)),s.version&&this.versionAttribute&&c[this.versionAttribute]){var a=c[this.versionAttribute];r(this,s,a,n)}return d},_destroyed:{},isDestroyed:function(e){return e||(e={}),i.defaults(e,{mode:d.defaultMode()}),this._destroyed[e.mode]||!1},fetch:function(e){return e||(e={}),i.defaults(e,{mode:d.defaultMode()}),h.apply(this,[e])},save:function(e,t,r){var o;return null==e||"object"==typeof e?(o=e,r=t):(o={})[e]=t,r||(r={}),i.defaults(r,{mode:d.defaultMode()}),r.changes=r.patch?o:i.extend(i.clone(this.attributes),o),f.apply(this,[o,r])},destroy:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=this,r=e.success,o=e.wait;if(e.success=function(i){o&&(t._dirtyDestroyed=!0),r&&r.call(e.context,t,i,e)},o||(t._dirtyDestroyed=!0),this.isNew()){var s=function(){t.stopListening(),t.trigger("destroy",t,t.collection,e)};return e.success=function(i){o&&(t._dirtyDestroyed=!0),o&&s(),r&&r.call(e.context,t,i,e),t.isNew()||t.trigger("sync",t,i,e)},i.defer(e.success),o||s(),M(this,e),this.sync("delete",this,e)}return p.apply(this,[e])},pull:function(e){return e||(e={}),i.defaults(e,{mode:d.defaultMode()}),e.mode,this.isFetched(e)?(i.defer(e.success,this,void 0,e),void 0):this.fetch(e)},push:function(e){if(e||(e={}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(e)}return this.isNew()?this.save(null,e):this.hasDirtied(null,e)?this.save(this.dirtiedAttributes(e),e):void 0},checkUrl:"",check:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=e.checkUrl||i.result(this,"checkUrl");if(!t)throw Error('The "checkUrl" must be specified.');return this.fetch(i.extend(e,{url:t,version:!0}))},toJSON:function(e){var t=y.call(this,e);return e&&!e.cid&&delete t[this.cidAttribute],t}},{create:function(e,t){if(t||(t={}),t.idAttribute&&e[t.idAttribute]){var r=e[t.idAttribute];delete e[t.idAttribute],e[this.prototype.idAttribute]=r}if(t.cidAttribute&&e[t.cidAttribute]){var r=e[t.cidAttribute];delete e[t.cidAttribute],e[this.prototype.cidAttribute]=r}e&&e[this.prototype.idAttribute];var o=this.find(e);return o?e!==o.attributes?(o.set(o.parse(e),i.extend(t,{silent:!1})),o):(t.validate&&o._validate({},t),o):(t.parse=!0,new this(e,t))},find:function(e){if(!e)return!1;var t=e[this.prototype.cidAttribute],i=e[this.prototype.idAttribute];return(t||i)&&this.register().get(t||i)||!1},register:function(){if(!this._register){var e=this,i=t.Collection.extend({model:e}),r=this._register=new i;r.on("destroy",function(e){e.isDirtyDestroyed()&&!e.isDestroyed()&&r.add(e,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),t.Collection.prototype.initialize;var v=t.Collection.prototype.fetch;t.Collection=t.Collection.extend({idsUrl:function(e){return"/"+e.join(";")},fetch:function(e){return e=i.extend({parse:!0},e),i.defaults(e,{mode:d.defaultMode()}),v.apply(this,[e])},save:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=e.success;e.originalSuccess=e.success;var r=this;return e.success=function(i){var o=e.reset?"reset":"set";r[o](i,e),t&&t.call(e.context,r,i,e),r.trigger("sync",r,i,e)},this.sync("update",this,e)},destroy:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=e.success;e.originalSuccess=e.success;var r=this;return e.success=function(i){t&&t.call(e.context,r,i,e),r.trigger("sync",r,i,e)},this.sync("delete",this,e)},pull:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=e.success;if(e.remove=!1,e.modelsToFetch=this.filter(function(e){return!e.isNew()&&!e.isFetched()}),i.isEmpty(e.modelsToFetch))return i.defer(t,this,void 0,e),void 0;var r=i.map(e.modelsToFetch,function(e){return e.id});return e.url=i.result(this,"url")+this.idsUrl(r),this.fetch(e)},push:function(e){var t=i.clone(this.models);i.each(t,function(t){t.push(e)})},checkUrl:"",check:function(e){e||(e={}),i.defaults(e,{mode:d.defaultMode()});var t=e.checkUrl||i.result(this,"checkUrl");if(!t)throw Error('The "checkUrl" must be specified.');return this.fetch(i.extend(e,{url:t,version:!0}))}});var m=function(e,t,i){i||(i={}),i.method=e;var r=i.mode;if(g(e,t,i),r){var o=d.mode(r);if(o)return o.apply(i.context,[e,t,i]);throw Error('The "mode" passed must be implemented.')}return d.backboneSync.apply(i.context,[e,t,i])},g=function(e,r,o){var s=o.mode;if(r instanceof t.Model)switch(e){case"create":case"update":case"patch":var c=o.success;o.success=function(t){"create"===e&&(r._fetched[s]=!0),i.each(o.changes,function(e,t){var i=r.dirtied[s][t];i===e&&delete r.dirtied[s][t]}),c&&c.call(o.context,t)};break;case"delete":var c=o.success;o.success=function(e){r._destroyed[s]=!0,c&&c.call(o.context,e)};break;case"read":var c=o.success;o.success=function(e){o.version||(r._fetched[s]=!0),c&&c.call(o.context,e)}}else if(r instanceof t.Collection){var n=r;switch(e){case"read":var c=o.success;o.success=function(e){i.each(n.models,function(t){var r={};r[t.idAttribute]=t.id,i.findWhere(e,r),o.version||(t._fetched[s]=!0)}),c&&c.call(o.context,e)}}}},b=function(e,r,o){if(o.mode,r instanceof t.Model)i.defer(o.success);else if(r instanceof t.Collection){o.success=o.originalSuccess;var s=r;switch(e){case"create":case"update":case"patch":s.each(function(e){e.save(null,o)});break;case"delete":s.each(function(e){e.destroy(o)})}}},S=function(e,r,o){if(o.mode,r instanceof t.Model)switch(e){case"create":case"update":case"patch":var s=o.success;return o.success=function(e){o.dirty=!1,s&&s.call(o.context,e)},d.backboneSync.apply(this,[e,r,o]);case"delete":return r.isNew()?!1:(o.dirty=!1,r.constructor.register().remove(r),d.backboneSync.apply(this,[e,r,o]));case"read":return o.dirty=!1,d.backboneSync.apply(this,[e,r,o])}else if(r instanceof t.Collection){var c=r;switch(e){case"read":var s=o.success;return o.remove=!1,o.success=function(e){o.dirty=!1;var t=o.reset?"reset":"set";c[t](e,o),s&&s.call(o.context,e)},d.backboneSync.apply(this,[e,c,o]);case"create":case"update":case"patch":o.success=o.originalSuccess,c.each(function(e){e.save(null,o)});break;case"delete":o.success=o.originalSuccess;var n=i.clone(c.models);i.each(n,function(e){e.destroy(o)})}}},x={client:b,server:S};d.register(x),d.defaultMode("server"),t.sync=m;var M=function(e,t){var i=t.error;t.error=function(r){i&&i.call(t.context,e,r,t),e.trigger("error",e,r,t)}};i.extend(t.Repository,{storagePrefix:void 0,compressStorage:!1,storage:function(){return _()},serialKey:{attributes:0,dirtiedAttributes:1,dirtyDestroyed:2,changes:3,previousAttributes:4,fetched:5,destroyed:6,sid:7}});var k,A=t.Repository.serialKey,_=function(){return k||(k=new e.Store({compress:t.Repository.compressStorage})),k},N={};e.Store.prototype.setVersion=function(e){var t=_(),i=t.get("storageVersion");o(e,i)&&t.clear()};var w=function(e){this.model=e,this.localCache=e.constructor.register()};i.extend(w.prototype,{load:function(e){var t=_(),i=this.key(e),r=t.get(i);r&&(this.deserialize(r,e),this.localCache.add(this.model))},store:function(e){var t=_();this.model.sid&&this.model.id&&this.remove(e);var r=this.key(e),o=this.serialize(e);t.set(r,o,i.extend({},e))},remove:function(e){var t=_(),i=this.key(e);t.remove(i),delete this.model.sid,delete N[this.model.sid]},key:function(e){e||(e={});var r=t.Repository.storagePrefix,o=e.storeName||i.result(this.model,"storeName")||i.result(this.model.constructor,"storeName")||B(),s=this.model.sid||this.model.id||this.sid();return r+":"+o+":"+s},sid:function(){var e=c();return this.model.sid=e,N[e]=this.model[this.model.cidAttribute],e},serialize:function(e){var t={};t[A.attributes]=this.model.toJSON(i.extend({},e,{cid:!1})),t[A.dirtiedAttributes]=i.omit(this.model.dirtied,"cid"),t[A.dirtyDestroyed]=this.model._dirtyDestroyed,t[A.changes]=i.omit(this.model.changed,"cid"),t[A.previousAttributes]=i.omit(this.model._previousAttributes,"cid"),t[A.fetched]=this.model._fetched,t[A.destroyed]=this.model._destroyed;var r=this.model.sid;return r&&(t[A.sid]=r),t},deserialize:function(e,t){var r=e[A.sid];this.model.sid=r;var o=e[A.attributes];this.model.set(o,i.extend({},t,{localStorage:!1})),this.model.dirtied=e[A.dirtiedAttributes],this.model._dirtyDestroyed=e[A.dirtyDestroyed],this.model.changed=e[A.changes],this.model._previousAttributes=e[A.previousAttributes],this.model._fetched=e[A.fetched],this.model._destroyed=e[A.destroyed]}});var D=function(e){this.collection=e};i.extend(D.prototype,{load:function(e){var t=_(),i=this.key(e),r=t.get(i);r&&this.deserialize(r,e)},store:function(e){var t=_(),r=this.key(e),o=this.serialize(e);t.set(r,o,i.extend({},e)),this.collection.each(function(i){try{var r=i.storage().key();t.get(r)||i.storage().store(e)}catch(o){}},this)},remove:function(e){var t=_(),i=this.key(e);t.remove(i)},key:function(e){e||(e={});var r=t.Repository.storagePrefix,o=e.storeName||i.result(this.collection,"storeName")||B();return r+":"+o},serialize:function(e){var t=[];return this.collection.each(function(i){try{t.push(i.storage().key())}catch(r){t.push(i.storage().serialize(e))}},this),t},deserialize:function(e,t){var r=_(),o=[];for(var s in e){var c=e[s];if(i.isString(c)){var n,d,a=r.get(c);if(n=a[A.sid]){var l={};N[n]&&(l.cid=N[n]),d=this.collection._prepareModel(l,i.extend({},t,{idAttribute:"id",cidAttribute:"cid"})),d.sid=n,N[n]=d[d.cidAttribute]}else if(!i.isUndefined(a[A.attributes].id)){var l={};l.id=a[A.attributes].id,d=this.collection._prepareModel(l,i.extend({},t,{idAttribute:"id",cidAttribute:"cid"}))}if(!d)continue;d.storage().load()}else d=this.collection._prepareModel(c,t);o.push(d)}this.collection.set(o,i.extend({},t,{localStorage:!1}))}});var z=t.Model.prototype.constructor.register;i.extend(t.Model.prototype.constructor,{storeName:void 0,register:function(){var e=z.call(this);return e.storeName||(e.storeName=this.storeName+":register",e.on("update",function(e,t,i){i&&i.localStorage&&this.storage().store()},e)),e}}),t.Model.prototype.initialize;var C=t.Model.prototype.set,J=t.Model.prototype.fetch,O=t.Model.prototype.destroy,U=t.Model.prototype.pull;i.extend(t.Model.prototype,{storage:function(){return new w(this)},set:function(e,t,i){if(null==e)return i=t,i&&i.localStorage&&this.storage().store(i.localStorage),this;var r;"object"==typeof e?(r=e,i=t):(r={})[e]=t;var o=C.call(this,r,i);return i&&i.localStorage&&this.storage().store(i.localStorage),o},fetch:function(e){return e&&e.localStorage&&this.storage().load(e.localStorage),J.call(this,e)},destroy:function(e){var t=this,i=e.success,r=function(){e&&e.localStorage&&t.storage().remove(e.localStorage)},o=e.wait;return e.success=function(s){o&&r(),i&&i.call(e.context,t,s,e)},o||r(),O.call(this,e)},pull:function(e){return e&&e.localStorage&&this.storage().load(e.localStorage),U.call(this,e)}});var R=t.Collection.prototype.set,T=t.Collection.prototype.fetch,j=t.Collection.prototype.save,E=t.Collection.prototype.destroy,F=t.Collection.prototype.pull;i.extend(t.Collection.prototype,{storeName:void 0,storage:function(){return new D(this)},set:function(e,t){var i=R.call(this,e,t);return t&&t.localStorage&&this.storage().store(t.localStorage),i},fetch:function(e){return e&&e.localStorage&&this.storage().load(e.localStorage),T.call(this,e)},save:function(e){return e&&e.localStorage&&this.storage().store(e.localStorage),j.call(this,e)},destroy:function(e){return e&&e.localStorage&&this.storage().remove(e.localStorage),E.call(this,e)},pull:function(e){return e&&e.localStorage&&this.storage().load(e.localStorage),F.call(this,e)}});var B=function(){throw Error('An "storeName" property or function must be specified for storage')},V=function(e,t,r){var o=r.success;switch(e){case"create":case"update":case"patch":t.storage().store(r),o&&i.defer(o);break;case"delete":t.storage().remove(r),o&&i.defer(o);break;case"read":t.storage().load(r),o&&i.defer(o)}};d.register("localStorage",V)});