(function(t,e){if("function"==typeof define&&define.amd)define(["backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore");module.exports=e(i,r)}else e(t.Backbone,t._)})(this,function(t,e){"use strict";function i(t,i){if(e.isUndefined(t))return!1;if(e.isUndefined(i))return!0;if(e.isNumber(t)&&e.isNumber(i))return t>i;var r=t+"",n=i+"";return r.localeCompare(n)>0}function r(t,i,r){var n=r.mode;switch(t){case"create":case"update":case"patch":var s=r.success;return"client"===n?(e.defer(s,i,{},r),void 0):(r.success=function(n){"create"===t&&(i._fetched=!0),e.each(r.changes,function(t,e){var r=i.dirtied[e];r===t&&delete i.dirtied[e]}),s&&s.call(r.context,n)},d.apply(this,[t,i,r]));case"delete":var s=r.success;return"client"===n?(e.defer(s,i,{},r),void 0):(r.success=function(t){"server"===n&&(i.constructor.all().remove(i),i._destroyed=!0),s&&s.call(r.context,t)},d.apply(this,[t,i,r]));case"read":var s=r.success;return"infinite"===n&&i.isFetched()?(e.defer(s,i,{},r),void 0):(r.success=function(t){i._fetched=!0,s&&s.call(r.context,t)},d.apply(this,[t,i,r]))}}function n(t,i,r){var n=r.mode;switch(t){case"read":var s=r.success;r.remove=!1;var o;if("infinite"===n){if(o=i.filter(function(t){return!t.isNew()&&!t.isFetched()}),e.isEmpty(o))return e.defer(s,i,{},r),void 0;var c=e.map(o,function(t){return t.id});r.url=i.idsUrl(c)}return r.success=function(t){var n=r.reset?"reset":"set";i[n](t,r);var o=t;e.each(o,function(t){var e=i.get(t);e._fetched=!0}),i.fetched=!0,s&&s.call(r.context,t)},d.apply(this,[t,i,r])}}t.Syncer={IDS_URL_SEPARATOR:"/",IDS_SEPARATOR:";"},t.Syncer.VERSION="0.1.0",function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(r,n){return e.each(r,function(s,o){s instanceof t.Model||s instanceof t.Collection?r[o]=s.toJSON({deepJson:n}):e.isObject(s)&&n&&(r[o]=i(e.clone(s),n))}),r};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var r=arguments[1];r||(r={});var n;return e.isBoolean(r.omit)&&r.omit||e.isBoolean(r.pick)&&!r.pick?{}:(n=e.isBoolean(r.pick)&&r.pick||e.isBoolean(r.omit)&&!r.omit?t.call(this,r):r.pick?e.pick(this.attributes,r.pick):r.omit?e.omit(this.attributes,r.omit):t.call(this,r),n=i(n,r.deepJson))})}(t,e);var s=t.Model;t.Model.prototype.toJSON;var o=t.Model.prototype.set,c=t.Model.prototype.save;t.Model=t.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==t.Model.prototype.initialize){var i=this,r=this.initialize;this.initialize=e.wrap(t.Model.prototype.initialize,function(t){t.call(i,arguments[2]),r.call(i,arguments[2])})}return s.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,e.extend(this.dirtied,e.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.all().add(this),this.on("destroy",function(t){t._dirtyDestroyed=!0}),this.versionAttribute&&this.on("change:"+this.versionAttribute,function(t,e,r){var n=t.previousAttributes()[t.versionAttribute];r&&r.version&&i(e,n)&&(t._fetched=!1)})},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return e.clone(this.dirtied)},hasDirtied:function(t){return null==t?!e.isEmpty(this.dirtied):e.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,i,r){if(null==t)return this;var n;return"object"==typeof t?(n=t,r=i):(n={})[t]=i,r||(r={}),o.call(this,n,r),r.mode&&"client"!==r.mode||e.extend(this.dirtied,e.omit(n,[this.idAttribute,this.cidAttribute])),this},_destroyed:!1,isDestroyed:function(){return this._destroyed},save:function(t,i,r){var n;return null==t||"object"==typeof t?(n=t,r=i):(n={})[t]=i,r||(r={}),r.changes=r.patch?n:e.extend(e.clone(this.attributes),n),c.apply(this,[n,r])},pull:function(t){return t||(t={}),this.fetch(e.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var t=e.extend(t,{mode:"server"});if(this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save({},t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0}},{create:function(t,i){i||(i={}),t&&t[this.prototype.idAttribute];var r=this.find(t);return r?t!==r.attributes?(r.set(r.parse(t),e.extend(i,{silent:!1})),r):(i.validate&&r._validate({},i),r):(i.parse=!0,new this(t,i))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.all().get(e||i)||!1},all:function(){if(!this._all){var e=this,i=t.Collection.extend({model:e}),r=this._all=new i;r.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&r.add(t,{silent:!0})})}return this._all},reset:function(){this.all().reset()}}),t.Collection.prototype.initialize,t.Collection.prototype.fetch,t.Collection=t.Collection.extend({idsUrl:function(i){var r=e.result(this,"url")||l();return r+t.Syncer.IDS_URL_SEPARATOR+i.join(t.Syncer.IDS_SEPARATOR)},fetch:function(t){t=e.extend({parse:!0},t);var i=t.success,r=this;return t.success=function(e){i&&i.call(t.context,r,e,t),r.trigger("sync",r,e,t)},a(this,t),this.sync("read",this,t)},save:function(t){t||(t={});var e=[];return this.each(function(i){var r=i.save([],t);e.push(r)}),e},destroy:function(t){t||(t={});var i=[],r=e.extend([],this.models);return e.each(r,function(e){var r=e.destroy(t);i.push(r)}),i},pull:function(t){return t||(t={}),this.fetch(e.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var i=[],r=e.extend([],this.models);return e.each(r,function(e){var r=e.push(t);i.push(r)}),i}});var d=t.sync,u={};u.sync=function(e,i,s){return s||(s={}),s.method=e,s.mode||(s.mode="server"),i instanceof t.Model?r.apply(this,[e,i,s]):i instanceof t.Collection?n.apply(this,[e,i,s]):void 0};var a=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}},l=function(){throw Error('A "url" property or function must be specified')};t.sync=u.sync});