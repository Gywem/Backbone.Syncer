(function(t,e){if("function"==typeof define&&define.amd)define(["backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),s=require("underscore");module.exports=e(i,s)}else e(t.Backbone,t._)})(this,function(t,e){"use strict";function i(t,i,s){var n=s.mode;switch(t){case"create":case"update":case"patch":var r=s.success;return"client"===n?(e.defer(r,i,{},s),void 0):(s.success=function(n){"create"===t&&(i._fetched=!0),e.each(s.changes,function(t,e){var s=i.dirtied[e];s===t&&delete i.dirtied[e]}),r&&r.call(s.context,n)},c.apply(this,[t,i,s]));case"delete":var r=s.success;return"client"===n?(e.defer(r,i,{},s),void 0):(s.success=function(t){"server"===n&&(i.constructor.all().remove(i),i._destroyed=!0),r&&r(s.context,t)},c.apply(this,[t,i,s]));case"read":var r=s.success;return"infinite"===n&&i.isFetched()?(e.defer(r,i,{},s),void 0):(s.success=function(t){i._fetched=!0,r&&r(s.context,t)},c.apply(this,[t,i,s]))}}function s(t,e,i){switch(i.mode,t){case"create":case"update":case"patch":break;case"delete":break;case"read":}}t.Syncer={},t.Syncer.VERSION="0.1.0",function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.1.0";var i=t.Model.prototype.toJSON,s=function(i){return e.each(i,function(n,r){n instanceof t.Model||n instanceof t.Collection?i[r]=n.toJSON():e.isObject(n)&&(i[r]=s(e.clone(n)))}),i};t.Model.prototype.exToJSON=i,t.Model.prototype.toJSON=e.wrap(i,function(t){var i,n=arguments[1];return n&&n.includeInJson?i=e.pick(this.attributes,n.includeInJson):n&&n.excludeInJson?i=e.omit(this.attributes,n.excludeInJson):n&&n.filterInJson?(i={},e.each(this.attributes,function(t,e){n.filterInJson(t,e)&&(i[e]=t)})):i=t.call(this,n),i=s(i)})}(t,e);var n=t.Model;t.Model.prototype.toJSON;var r=t.Model.prototype.set,o=t.Model.prototype.save;t.Model=t.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==t.Model.prototype.initialize){var i=this,s=this.initialize;this.initialize=e.wrap(t.Model.prototype.initialize,function(t){t.call(i,arguments[2]),s.call(i,arguments[2])})}return n.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,e.extend(this.dirtied,e.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.all().add(this),this.on("destroy",function(t){t._dirtyDestroyed=!0})},_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return e.clone(this.dirtied)},hasDirtied:function(t){return null==t?!e.isEmpty(this.dirtied):e.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},set:function(t,i,s){if(null==t)return this;var n;return"object"==typeof t?(n=t,s=i):(n={})[t]=i,s||(s={}),r.call(this,n,s),s.mode&&"client"!==s.mode||e.extend(this.dirtied,e.omit(n,[this.idAttribute,this.cidAttribute])),this},_destroyed:!1,isDestroyed:function(){return this._destroyed},save:function(t,i,s){var n;return null==t||"object"==typeof t?(n=t,s=i):(n={})[t]=i,s||(s={}),s.changes=s.patch?n:e.extend(e.clone(this.attributes),n),o.apply(this,[t,i,s])},pull:function(t){return t||(t={}),this.fetch(e.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var t=e.extend(t,{mode:"server"});if(this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save({},t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0}},{create:function(t,i){i||(i={}),t&&t[this.prototype.idAttribute];var s=this.find(t);return s?t!==s.attributes?(s.set(s.parse(t),e.extend(i,{silent:!1})),s):(i.validate&&s._validate({},i),s):(i.parse=!0,new this(t,i))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.all().get(e||i)||!1},all:function(){if(!this._all){var e=this,i=t.Collection.extend({model:e}),s=this._all=new i;s.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&s.add(t,{silent:!0})})}return this._all},reset:function(){this.all().reset()}}),t.Collection=t.Collection.extend({});var c=t.sync,d={};d.sync=function(e,n,r){return r||(r={}),r.method=e,r.mode||(r.mode="server"),n instanceof t.Model?i.apply(this,[e,n,r]):n instanceof t.Collection?s.apply(this,[e,n,r]):void 0},t.sync=d.sync});