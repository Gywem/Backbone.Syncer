(function(t,e){if("function"==typeof define&&define.amd)define(["locallyjs","backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore"),o=require("locallyjs");module.exports=e(o,i,r)}else e(t.Locally,t.Backbone,t._)})(this,function(t,e,i){"use strict";function r(t,e,r){var o=r.mode;switch(t){case"create":case"update":case"patch":var s=r.success;return"client"===o?(i.defer(s),void 0):(r.success=function(o){r.response=!0,"create"===t&&(e._fetched=!0),i.each(r.changes,function(t,i){var r=e.dirtied[i];r===t&&delete e.dirtied[i]}),s&&s.call(r.context,o)},f.apply(this,[t,e,r]));case"delete":var s=r.success;return"client"===o?(i.defer(s),void 0):(r.success=function(t){r.response=!0,"server"===o&&(e.constructor.all().remove(e),e._destroyed=!0),s&&s.call(r.context,t)},f.apply(this,[t,e,r]));case"read":var s=r.success;return"client"===o?(i.defer(s),void 0):"infinite"===o&&e.isFetched()?(i.defer(s),void 0):(r.success=function(t){r.response=!0,e._fetched=!0,s&&s.call(r.context,t)},f.apply(this,[t,e,r]))}}function o(t,e,r){var o=r.mode;switch(t){case"read":var s=r.success;r.remove=!1;var n;if("infinite"===o){if(n=e.filter(function(t){return!t.isNew()&&!t.isFetched()}),i.isEmpty(n))return i.defer(s),void 0;var c=i.map(n,function(t){return t.id});r.url=e.idsUrl(c)}return r.success=function(t){r.response=!0;var o=r.reset?"reset":"set";e[o](t,r);var n=t;i.each(n,function(t){var i=e.get(t);i._fetched=!0}),e.fetched=!0,s&&s.call(r.context,t)},f.apply(this,[t,e,r])}}function s(t,e){return i.isUndefined(t)?!1:i.isUndefined(e)?!0:t!==e}function n(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function c(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}e.Syncer={serverSync:e.sync,IDS_URL_SEPARATOR:"/",IDS_SEPARATOR:";",VERSION:"0.1.0"},function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(r,o){return e.each(r,function(s,n){s instanceof t.Model||s instanceof t.Collection?r[n]=s.toJSON({deepJson:o}):e.isObject(s)&&o&&(r[n]=i(e.clone(s),o))}),r};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var r=arguments[1];r||(r={});var o;return e.isBoolean(r.omit)&&r.omit||e.isBoolean(r.pick)&&!r.pick?{}:(o=e.isBoolean(r.pick)&&r.pick||e.isBoolean(r.omit)&&!r.omit?t.call(this,r):r.pick?e.pick(this.attributes,r.pick):r.omit?e.omit(this.attributes,r.omit):t.call(this,r),o=i(o,r.deepJson))})}(e,i);var d=e.Model,a=e.Model.prototype.set,l=e.Model.prototype.save,u=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var t=this,r=this.initialize;this.initialize=i.wrap(e.Model.prototype.initialize,function(e){e.call(t,arguments[2]),r.call(t,arguments[2])})}return d.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,i.extend(this.dirtied,i.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.all().add(this),this.on("destroy",function(t){t._dirtyDestroyed=!0}),this.versionAttribute&&this.on("change:"+this.versionAttribute,function(t,e,i){var r=t.previousAttributes()[t.versionAttribute];i&&i.version&&s(e,r)&&(t._fetched=!1)})},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return i.clone(this.dirtied)},hasDirtied:function(t){return null==t?!i.isEmpty(this.dirtied):i.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,e,r){if(null==t)return this;var o;"object"==typeof t?(o=t,r=e):(o={})[t]=e,r||(r={});var s=a.call(this,o,r);return r.response||i.extend(this.dirtied,i.omit(o,[this.idAttribute,this.cidAttribute])),s},_destroyed:!1,isDestroyed:function(){return this._destroyed},save:function(t,e,r){var o;return null==t||"object"==typeof t?(o=t,r=e):(o={})[t]=e,r||(r={}),r.changes=r.patch?o:i.extend(i.clone(this.attributes),o),l.apply(this,[o,r])},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var t=i.extend(t,{mode:"server"});if(this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save({},t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0},toJSON:function(t){var e=u.call(this,t);return t&&!t.cid&&delete e[this.cidAttribute],e}},{create:function(t,e){if(e||(e={}),e.idAttribute&&t[e.idAttribute]){var r=t[e.idAttribute];delete t[e.idAttribute],t[this.prototype.idAttribute]=r}if(e.cidAttribute&&t[e.cidAttribute]){var r=t[e.cidAttribute];delete t[e.cidAttribute],t[this.prototype.cidAttribute]=r}t&&t[this.prototype.idAttribute];var o=this.find(t);return o?t!==o.attributes?(o.set(o.parse(t),i.extend(e,{silent:!1})),o):(e.validate&&o._validate({},e),o):(e.parse=!0,new this(t,e))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.all().get(e||i)||!1},all:function(){if(!this._all){var t=this,i=e.Collection.extend({model:t}),r=this._all=new i;r.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&r.add(t,{silent:!0})})}return this._all},reset:function(){this.all().reset()}}),e.Collection.prototype.initialize;var h=e.Collection.prototype.fetch;e.Collection=e.Collection.extend({idsUrl:function(t){var r=i.result(this,"url")||v();return r+e.Syncer.IDS_URL_SEPARATOR+t.join(e.Syncer.IDS_SEPARATOR)},fetch:function(t){t=i.extend({parse:!0},t);var e=t.success,r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},y(this,t),this.sync("read",this,t)},save:function(t){t||(t={});var e=[];return this.each(function(i){var r=i.save([],t);e.push(r)}),e},destroy:function(t){t||(t={});var e=[],r=i.extend([],this.models);return i.each(r,function(i){var r=i.destroy(t);e.push(r)}),e},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var e=[],r=i.extend([],this.models);return i.each(r,function(i){var r=i.push(t);e.push(r)}),e}});var f=e.Syncer.serverSync,p={};p.sync=function(t,i,s){return s||(s={}),s.method=t,s.mode||(s.mode="server"),i instanceof e.Model?r.apply(this,[t,i,s]):i instanceof e.Collection?o.apply(this,[t,i,s]):void 0},e.sync=p.sync;var y=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}},v=function(){throw Error('A "url" property or function must be specified')};i.extend(e.Syncer,{storagePrefix:void 0,compressStorage:!1,storage:function(){return g()}});var m,g=function(){return m||(m=new t.Store({compress:e.Syncer.compressStorage})),m},b={};t.Store.prototype.setVersion=function(t){var e=g(),i=e.get("storageVersion");s(t,i)&&e.clear()};var S=function(t){this.model=t,this.localCache=t.constructor.all()};i.extend(S.prototype,{load:function(t){var e=g(),i=this.key(t),r=e.get(i);r&&(this.deserialize(r,t),this.localCache.add(this.model))},store:function(t){var e=g();this.model.sid&&this.model.id&&this.remove(t);var r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t))},remove:function(t){var e=g(),i=this.key(t);e.remove(i),delete this.model.sid,delete b[this.model.sid]},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.model.constructor,"storeName")||J(),s=this.model.sid||this.model.id||this.sid();return r+":"+o+":"+s},sid:function(){var t=c();return this.model.sid=t,b[t]=this.model[this.model.cidAttribute],t},serialize:function(t){var e={attrs:this.model.toJSON(i.extend({},t,{cid:!1})),state:{dirtied:this.model.dirtiedAttributes(),dirtiedDestroyed:this.model.isDirtyDestroyed(),changed:this.model.changedAttributes(),previous:this.model.previousAttributes(),fetched:this.model.isFetched(),destroyed:this.model.isDestroyed()}},r=this.model.sid;return r&&(e.sid=r),e},deserialize:function(t,e){var r=t.sid;this.model.sid=r;var o=t.attrs;this.model.set(o,i.extend({},e,{localStorage:!1}));var s=t.state;this.model.dirtied=s.dirtied,this.model._dirtyDestroyed=s.dirtiedDestroyed,this.model.changed=s.changed,this.model._previousAttributes=s.previous,this.model._fetched=s.fetched,this.model._destroyed=s.destroyed}});var A=function(t){this.collection=t};i.extend(A.prototype,{load:function(t){var e=g(),i=this.key(t),r=e.get(i);r&&this.deserialize(r,t)},store:function(t){var e=g(),r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t)),this.collection.each(function(i){try{var r=i.storage().key();e.get(r)||i.storage().store(t)}catch(o){}},this)},remove:function(t){var e=g(),i=this.key(t);e.remove(i)},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.collection,"storeName")||J();return r+":"+o},serialize:function(t){var e=[];return this.collection.each(function(i){try{e.push(i.storage().key())}catch(r){e.push(i.storage().serialize(t))}},this),e},deserialize:function(t,e){var r=g(),o=[];for(var s in t){var n=t[s];if(i.isString(n)){var c,d,a=r.get(n);if(c=a.sid){var l={};b[c]&&(l.cid=b[c]),d=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"})),d.sid=c,b[c]=d[d.cidAttribute]}else if(!i.isUndefined(a.attrs.id)){var l={};l.id=a.attrs.id,d=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"}))}if(!d)continue;d.storage().load()}else d=this.collection._prepareModel(n,e);o.push(d)}this.collection.set(o,i.extend({},e,{localStorage:!1}))}});var x=e.Model.prototype.constructor.all;i.extend(e.Model.prototype.constructor,{storeName:void 0,all:function(){var t=x.call(this);return t.storeName||(t.storeName=this.storeName+":all",t.on("update",function(t,e,i){i&&i.localStorage&&this.storage().store()},t)),t}});var _=e.Model.prototype.initialize,D=e.Model.prototype.set,N=e.Model.prototype.fetch;i.extend(e.Model.prototype,{storage:function(){return new S(this)},initialize:function(t){_.call(this,t),this.on("destroy",function(t,e,i){i&&i.localStorage&&this.storage().remove(i.localStorage)},this)},set:function(t,e,i){if(null==t)return i=e,i&&i.localStorage&&this.storage().store(i.localStorage),this;var r;"object"==typeof t?(r=t,i=e):(r={})[t]=e;var o=D.call(this,r,i);return i&&i.localStorage&&this.storage().store(i.localStorage),o},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),N.call(this,t)}});var M=e.Collection.prototype.set,h=e.Collection.prototype.fetch,k=e.Collection.prototype.save,z=e.Collection.prototype.destroy;i.extend(e.Collection.prototype,{storeName:void 0,storage:function(){return new A(this)},set:function(t,e){var i=M.call(this,t,e);return e&&e.localStorage&&this.storage().store(e.localStorage),i},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),h.call(this,t)},save:function(t){return t&&t.localStorage&&this.storage().store(t.localStorage),k.call(this,t)},destroy:function(t){return t&&t.localStorage&&this.storage().remove(t.localStorage),z.call(this,t)}});var J=function(){throw Error('An "storeName" property or function must be specified for storage')}});