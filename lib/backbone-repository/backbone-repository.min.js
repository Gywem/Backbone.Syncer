(function(e,t){if("function"==typeof define&&define.amd)define(["backbone","underscore"],t);else if("object"==typeof module&&module.exports){var i=require("backbone"),s=require("underscore");module.exports=t(i,s)}else t(e.Backbone,e._)})(this,function(e,t){"use strict";function i(e,i){return t.isUndefined(e)?!1:t.isUndefined(i)?!0:e!==i}var s,r={backboneSync:e.sync,modes:function(){return t.keys(n)},register:function(e,i){t.isObject(e)?t.extend(n,e):n[e]=i},unregister:function(e){delete n[e]},mode:function(e){return t.isFunction(e)?e:n[e]},defaultMode:function(e){return e?(s=t.isFunction(e)?t.findKey(n,function(t){return t===e}):e,void 0):s},reset:function(){n={}},VERSION:"0.1.0"},n={};e.Syncer=r,function(e,t){e.Jsonify={},e.Jsonify.VERSION="0.2.0",e.Jsonify.exToJSON=e.Model.prototype.toJSON;var i=function(s,r){return t.each(s,function(n,o){n instanceof e.Model||n instanceof e.Collection?s[o]=n.toJSON({deepJson:r}):t.isObject(n)&&r&&(s[o]=i(t.clone(n),r))}),s};e.Model.prototype.exToJSON=e.Jsonify.exToJSON,e.Model.prototype.toJSON=t.wrap(e.Jsonify.exToJSON,function(e){var s=arguments[1];s||(s={});var r;return t.isBoolean(s.omit)&&s.omit||t.isBoolean(s.pick)&&!s.pick?{}:(r=t.isBoolean(s.pick)&&s.pick||t.isBoolean(s.omit)&&!s.omit?e.call(this,s):s.pick?t.pick(this.attributes,s.pick):s.omit?t.omit(this.attributes,s.omit):e.call(this,s),r=i(r,s.deepJson))})}(e,t);var o=e.Model,c=e.Model.prototype.set,d=e.Model.prototype.fetch,u=e.Model.prototype.save,a=e.Model.prototype.destroy,l=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var i=this,s=this.initialize;this.initialize=t.wrap(e.Model.prototype.initialize,function(e){e.apply(i,t.rest(arguments)),s.apply(i,t.rest(arguments))})}return o.apply(this,arguments)},initialize:function(){this._fetched={},this.dirtied={},t.each(e.Syncer.modes(),function(e){this.dirtied[e]={}}.bind(this)),this._dirtyDestroyed=!1,this._destroyed={},t.each(e.Syncer.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),t.extend(this.dirtied[e],t.omit(this.attributes,[this.idAttribute,this.cidAttribute]))}.bind(this)),this.set(this.cidAttribute,this.cid);var i=this.constructor;i.register().add(this)},versionAttribute:!1,_fetched:{},isFetched:function(e){return e||(e={}),t.defaults(e,{mode:r.defaultMode()}),this._fetched[e.mode]||!1},dirtied:{},dirtiedAttributes:function(e){return e||(e={}),t.defaults(e,{mode:r.defaultMode()}),t.clone(this.dirtied[e.mode])||{}},hasDirtied:function(e,i){return i||(i={}),t.defaults(i,{mode:r.defaultMode()}),null==e?!t.isEmpty(this.dirtied[i.mode]):t.has(this.dirtied[i.mode],e)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){t.each(this.dirtied,function(e,t){this.dirtied[t]={}}.bind(this)),this.dirtiedDestroyed=!1},set:function(s,r,n){if(null==s)return this;var o;"object"==typeof s?(o=s,n=r):(o={})[s]=r,n||(n={}),t.isUndefined(n.dirty)&&(n.dirty=!0);var d=c.call(this,o,n);if(n.dirty&&t.each(e.Syncer.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),t.extend(this.dirtied[e],t.omit(o,[this.idAttribute,this.cidAttribute]))}.bind(this)),n&&n.version&&this.versionAttribute&&o[this.versionAttribute]){var u=this._previousAttributes[this.versionAttribute],a=o[this.versionAttribute];if(i(a,u)){var l=n.mode;l&&(this._fetched[l]=!1),this.trigger("outdated",this,a,n)}}return d},_destroyed:{},isDestroyed:function(e){return e||(e={}),t.defaults(e,{mode:r.defaultMode()}),this._destroyed[e.mode]||!1},fetch:function(e){return e||(e={}),t.defaults(e,{mode:r.defaultMode()}),d.apply(this,[e])},save:function(e,i,s){var n;return null==e||"object"==typeof e?(n=e,s=i):(n={})[e]=i,s||(s={}),t.defaults(s,{mode:r.defaultMode()}),s.changes=s.patch?n:t.extend(t.clone(this.attributes),n),u.apply(this,[n,s])},destroy:function(e){e||(e={}),t.defaults(e,{mode:r.defaultMode()});var i=this,s=e.success,n=e.wait;if(e.success=function(t){n&&(i._dirtyDestroyed=!0),s&&s.call(e.context,i,t,e)},n||(i._dirtyDestroyed=!0),this.isNew()){var o=function(){i.stopListening(),i.trigger("destroy",i,i.collection,e)};return e.success=function(t){n&&(i._dirtyDestroyed=!0),n&&o(),s&&s.call(e.context,i,t,e),i.isNew()||i.trigger("sync",i,t,e)},t.defer(e.success),n||o(),m(this,e),this.sync("delete",this,e)}return a.apply(this,[e])},pull:function(e){return e||(e={}),t.defaults(e,{mode:r.defaultMode()}),e.mode,this.isFetched(e)?(t.defer(e.success,this,void 0,e),void 0):this.fetch(e)},push:function(e){if(e||(e={}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(e)}return this.isNew()?this.save(null,e):this.hasDirtied(null,e)?this.save(this.dirtiedAttributes(e),e):void 0},toJSON:function(e){var t=l.call(this,e);return e&&!e.cid&&delete t[this.cidAttribute],t}},{create:function(e,i){if(i||(i={}),i.idAttribute&&e[i.idAttribute]){var s=e[i.idAttribute];delete e[i.idAttribute],e[this.prototype.idAttribute]=s}if(i.cidAttribute&&e[i.cidAttribute]){var s=e[i.cidAttribute];delete e[i.cidAttribute],e[this.prototype.cidAttribute]=s}e&&e[this.prototype.idAttribute];var r=this.find(e);return r?e!==r.attributes?(r.set(r.parse(e),t.extend(i,{silent:!1})),r):(i.validate&&r._validate({},i),r):(i.parse=!0,new this(e,i))},find:function(e){if(!e)return!1;var t=e[this.prototype.cidAttribute],i=e[this.prototype.idAttribute];return(t||i)&&this.register().get(t||i)||!1},register:function(){if(!this._register){var t=this,i=e.Collection.extend({model:t}),s=this._register=new i;s.on("destroy",function(e){e.isDirtyDestroyed()&&!e.isDestroyed()&&s.add(e,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),e.Collection.prototype.initialize;var f=e.Collection.prototype.fetch;e.Collection=e.Collection.extend({idsUrl:function(e){return"/"+e.join(";")},fetch:function(e){return e=t.extend({parse:!0},e),t.defaults(e,{mode:r.defaultMode()}),f.apply(this,[e])},save:function(e){e||(e={}),t.defaults(e,{mode:r.defaultMode()});var i=e.success;e.originalSuccess=e.success;var s=this;return e.success=function(t){var r=e.reset?"reset":"set";s[r](t,e),i&&i.call(e.context,s,t,e),s.trigger("sync",s,t,e)},this.sync("update",this,e)},destroy:function(e){e||(e={}),t.defaults(e,{mode:r.defaultMode()});var i=e.success;e.originalSuccess=e.success;var s=this;return e.success=function(t){i&&i.call(e.context,s,t,e),s.trigger("sync",s,t,e)},this.sync("delete",this,e)},pull:function(e){e||(e={}),t.defaults(e,{mode:r.defaultMode()});var i=e.success;if(e.remove=!1,e.modelsToFetch=this.filter(function(e){return!e.isNew()&&!e.isFetched()}),t.isEmpty(e.modelsToFetch))return t.defer(i,this,void 0,e),void 0;var s=t.map(e.modelsToFetch,function(e){return e.id});return e.url=t.result(this,"url")+this.idsUrl(s),this.fetch(e)},push:function(e){var i=t.clone(this.models);t.each(i,function(t){t.push(e)})}});var h=function(e,t,i){i||(i={}),i.method=e;var s=i.mode;if(p(e,t,i),s){var n=r.mode(s);if(n)return n.apply(i.context,[e,t,i]);throw Error('The "mode" passed must be implemented.')}return r.backboneSync.apply(i.context,[e,t,i])},p=function(i,s,r){var n=r.mode;if(s instanceof e.Model)switch(i){case"create":case"update":case"patch":var o=r.success;r.success=function(e){"create"===i&&(s._fetched[n]=!0),t.each(r.changes,function(e,t){var i=s.dirtied[n][t];i===e&&delete s.dirtied[n][t]}),o&&o.call(r.context,e)};break;case"delete":var o=r.success;r.success=function(e){s._destroyed[n]=!0,o&&o.call(r.context,e)};break;case"read":var o=r.success;r.success=function(e){s._fetched[n]=!0,o&&o.call(r.context,e)}}},y=function(i,s,r){if(r.mode,s instanceof e.Model)t.defer(r.success);else if(s instanceof e.Collection){r.success=r.originalSuccess;var n=s;switch(i){case"create":case"update":case"patch":n.each(function(e){e.save(null,r)});break;case"delete":n.each(function(e){e.destroy(r)})}}},v=function(i,s,n){var o=n.mode;if(s instanceof e.Model)switch(i){case"create":case"update":case"patch":var c=n.success;return n.success=function(e){n.dirty=!1,c&&c.call(n.context,e)},r.backboneSync.apply(this,[i,s,n]);case"delete":return s.isNew()?!1:(n.dirty=!1,s.constructor.register().remove(s),r.backboneSync.apply(this,[i,s,n]));case"read":return n.dirty=!1,r.backboneSync.apply(this,[i,s,n])}else if(s instanceof e.Collection){var d=s;switch(i){case"read":var c=n.success;return n.remove=!1,n.success=function(e){n.dirty=!1;var i=n.reset?"reset":"set";d[i](e,n);var s=e;t.each(s,function(e){var t=d.get(e);t._fetched[o]=!0}),d.fetched=!0,c&&c.call(n.context,e)},r.backboneSync.apply(this,[i,d,n]);case"create":case"update":case"patch":n.success=n.originalSuccess,d.each(function(e){e.save(null,n)});break;case"delete":n.success=n.originalSuccess;var u=t.clone(d.models);t.each(u,function(e){e.destroy(n)})}}},b={client:y,server:v};r.register(b),r.defaultMode("server"),e.sync=h;var m=function(e,t){var i=t.error;t.error=function(s){i&&i.call(t.context,e,s,t),e.trigger("error",e,s,t)}}});