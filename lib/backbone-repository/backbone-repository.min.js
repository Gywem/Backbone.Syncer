(function(e,t){if("function"==typeof define&&define.amd)define(["backbone","underscore"],t);else if("object"==typeof module&&module.exports){var i=require("backbone"),s=require("underscore");module.exports=t(i,s)}else t(e.Backbone,e._)})(this,function(e,t){"use strict";function i(e,t,i,r){if(s(i,r)){var o=t.mode;o&&(e._fetched[o]=!1),e.trigger("outdated",e,i,t)}}function s(e,i){return t.isUndefined(e)?!1:t.isUndefined(i)?!0:e!==i}var r,o={backboneSync:e.sync,modes:function(){return t.keys(n)},setMode:function(e,i){t.isObject(e)?t.extend(n,e):n[e]=i},removeMode:function(e){delete n[e]},getMode:function(e){return t.isFunction(e)?e:n[e]},getDefaultMode:function(){return r},setDefaultMode:function(e){r=t.isFunction(e)?t.findKey(n,function(t){return t===e}):e},resetModes:function(){n={}},VERSION:"1.0.0"},n={};e.Repository=o,function(e,t){e.Jsonify={},e.Jsonify.VERSION="0.2.0",e.Jsonify.exToJSON=e.Model.prototype.toJSON;var i=function(s,r){return t.each(s,function(o,n){o instanceof e.Model||o instanceof e.Collection?s[n]=o.toJSON({deepJson:r}):t.isObject(o)&&r&&(s[n]=i(t.clone(o),r))}),s};e.Model.prototype.exToJSON=e.Jsonify.exToJSON,e.Model.prototype.toJSON=t.wrap(e.Jsonify.exToJSON,function(e){var s=arguments[1];s||(s={});var r;return t.isBoolean(s.omit)&&s.omit||t.isBoolean(s.pick)&&!s.pick?{}:(r=t.isBoolean(s.pick)&&s.pick||t.isBoolean(s.omit)&&!s.omit?e.call(this,s):s.pick?t.pick(this.attributes,s.pick):s.omit?t.omit(this.attributes,s.omit):e.call(this,s),r=i(r,s.deepJson))})}(e,t);var c=e.Model,d=e.Model.prototype.set,u=e.Model.prototype.fetch,a=e.Model.prototype.save,l=e.Model.prototype.destroy,f=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var i=this,s=this.initialize;this.initialize=t.wrap(e.Model.prototype.initialize,function(e){e.apply(i,t.rest(arguments)),s.apply(i,t.rest(arguments))})}return c.apply(this,arguments)},initialize:function(){this.dirtied={},this._destroyed={},this._fetched={},t.each(e.Repository.modes(),function(e){this.dirtied[e]={},this._destroyed[e]=!1,this._fetched[e]=!1}.bind(this)),this._dirtyDestroyed=!1,t.each(e.Repository.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),t.extend(this.dirtied[e],t.omit(this.attributes,[this.idAttribute,this.cidAttribute]))}.bind(this)),this.set(this.cidAttribute,this.cid);var i=this.constructor;i.register().add(this)},versionAttribute:!1,_fetched:{},isFetched:function(e){return e||(e={}),t.defaults(e,{mode:o.getDefaultMode()}),this._fetched[e.mode]||!1},dirtied:{},dirtiedAttributes:function(e){return e||(e={}),t.defaults(e,{mode:o.getDefaultMode()}),t.clone(this.dirtied[e.mode])||{}},hasDirtied:function(e,i){return i||(i={}),t.defaults(i,{mode:o.getDefaultMode()}),null==e?!t.isEmpty(this.dirtied[i.mode]):t.has(this.dirtied[i.mode],e)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){t.each(this.dirtied,function(e,t){this.dirtied[t]={}}.bind(this)),this.dirtiedDestroyed=!1},set:function(s,r,o){if(null==s)return this;var n;"object"==typeof s?(n=s,o=r):(n={})[s]=r,o||(o={}),t.isUndefined(o.dirty)&&(o.dirty=!0);var c;o.version&&(c=this.attributes[this.versionAttribute]);var u=d.call(this,n,o);if(o.dirty&&t.each(e.Repository.modes(),function(e){this.dirtied[e]||(this.dirtied[e]={}),t.extend(this.dirtied[e],t.omit(n,[this.idAttribute,this.cidAttribute]))}.bind(this)),o.version&&this.versionAttribute&&n[this.versionAttribute]){var a=n[this.versionAttribute];i(this,o,a,c)}return u},_destroyed:{},isDestroyed:function(e){return e||(e={}),t.defaults(e,{mode:o.getDefaultMode()}),this._destroyed[e.mode]||!1},fetch:function(e){return e||(e={}),t.defaults(e,{mode:o.getDefaultMode()}),u.apply(this,[e])},save:function(e,i,s){var r;return null==e||"object"==typeof e?(r=e,s=i):(r={})[e]=i,s||(s={}),t.defaults(s,{mode:o.getDefaultMode()}),s.changes=s.patch?r:t.extend(t.clone(this.attributes),r),a.apply(this,[r,s])},destroy:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=this,s=e.success,r=e.wait;if(e.success=function(t){r&&(i._dirtyDestroyed=!0),s&&s.call(e.context,i,t,e)},r||(i._dirtyDestroyed=!0),this.isNew()){var n=function(){i.stopListening(),i.trigger("destroy",i,i.collection,e)};return e.success=function(t){r&&(i._dirtyDestroyed=!0),r&&n(),s&&s.call(e.context,i,t,e),i.isNew()||i.trigger("sync",i,t,e)},t.defer(e.success),r||n(),g(this,e),this.sync("delete",this,e)}return l.apply(this,[e])},pull:function(e){return e||(e={}),t.defaults(e,{mode:o.getDefaultMode()}),e.mode,this.isFetched(e)?(t.defer(e.success,this,void 0,e),void 0):this.fetch(e)},push:function(e){if(e||(e={}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(e)}return this.isNew()?this.save(null,e):this.hasDirtied(null,e)?this.save(this.dirtiedAttributes(e),e):void 0},checkUrl:"",check:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=e.checkUrl||t.result(this,"checkUrl");if(!i)throw Error('The "checkUrl" must be specified.');return this.fetch(t.extend(e,{url:i,version:!0}))},toJSON:function(e){var t=f.call(this,e);return e&&!e.cid&&delete t[this.cidAttribute],t}},{create:function(e,i){if(i||(i={}),i.idAttribute&&e[i.idAttribute]){var s=e[i.idAttribute];delete e[i.idAttribute],e[this.prototype.idAttribute]=s}if(i.cidAttribute&&e[i.cidAttribute]){var s=e[i.cidAttribute];delete e[i.cidAttribute],e[this.prototype.cidAttribute]=s}e&&e[this.prototype.idAttribute];var r=this.find(e);return r?e!==r.attributes?(r.set(r.parse(e),t.extend(i,{silent:!1})),r):(i.validate&&r._validate({},i),r):(i.parse=!0,new this(e,i))},find:function(e){if(!e)return!1;var t=e[this.prototype.cidAttribute],i=e[this.prototype.idAttribute];return(t||i)&&this.register().get(t||i)||!1},register:function(){if(!this._register){var t=this,i=e.Collection.extend({model:t}),s=this._register=new i;s.on("destroy",function(e){e.isDirtyDestroyed()&&!e.isDestroyed()&&s.add(e,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),e.Collection.prototype.initialize;var h=e.Collection.prototype.fetch;e.Collection=e.Collection.extend({idsUrl:function(e){return"/"+e.join(";")},fetch:function(e){return e=t.extend({parse:!0},e),t.defaults(e,{mode:o.getDefaultMode()}),h.apply(this,[e])},save:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=e.success;e.originalSuccess=e.success;var s=this;return e.success=function(t){var r=e.reset?"reset":"set";s[r](t,e),i&&i.call(e.context,s,t,e),s.trigger("sync",s,t,e)},this.sync("update",this,e)},destroy:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=e.success;e.originalSuccess=e.success;var s=this;return e.success=function(t){i&&i.call(e.context,s,t,e),s.trigger("sync",s,t,e)},this.sync("delete",this,e)},pull:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=e.success;if(e.remove=!1,e.modelsToFetch=this.filter(function(e){return!e.isNew()&&!e.isFetched()}),t.isEmpty(e.modelsToFetch))return t.defer(i,this,void 0,e),void 0;var s=t.map(e.modelsToFetch,function(e){return e.id});return e.url=t.result(this,"url")+this.idsUrl(s),this.fetch(e)},push:function(e){var i=t.clone(this.models);t.each(i,function(t){t.push(e)})},checkUrl:"",check:function(e){e||(e={}),t.defaults(e,{mode:o.getDefaultMode()});var i=e.checkUrl||t.result(this,"checkUrl");if(!i)throw Error('The "checkUrl" must be specified.');return this.fetch(t.extend(e,{url:i,version:!0}))}});var p=function(e,t,i){i||(i={}),i.method=e;var s=i.mode;if(y(e,t,i),s){var r=o.getMode(s);if(r)return r.apply(i.context,[e,t,i]);throw Error('The "mode" passed must be implemented.')}return o.backboneSync.apply(i.context,[e,t,i])},y=function(i,s,r){var o=r.mode;if(s instanceof e.Model)switch(i){case"create":case"update":case"patch":var n=r.success;r.success=function(e){"create"===i&&(s._fetched[o]=!0),t.each(r.changes,function(e,t){var i=s.dirtied[o][t];i===e&&delete s.dirtied[o][t]}),n&&n.call(r.context,e)};break;case"delete":var n=r.success;r.success=function(e){s._destroyed[o]=!0,n&&n.call(r.context,e)};break;case"read":var n=r.success;r.success=function(e){r.version||(s._fetched[o]=!0),n&&n.call(r.context,e)}}else if(s instanceof e.Collection){var c=s;switch(i){case"read":var n=r.success;r.success=function(e){t.each(c.models,function(i){var s={};s[i.idAttribute]=i.id,t.findWhere(e,s),r.version||(i._fetched[o]=!0)}),n&&n.call(r.context,e)}}}},v=function(i,s,r){if(r.mode,s instanceof e.Model)t.defer(r.success);else if(s instanceof e.Collection){r.success=r.originalSuccess;var o=s;switch(i){case"create":case"update":case"patch":o.each(function(e){e.save(null,r)});break;case"delete":o.each(function(e){e.destroy(r)})}}},b=function(i,s,r){if(r.mode,s instanceof e.Model)switch(i){case"create":case"update":case"patch":var n=r.success;return r.success=function(e){r.dirty=!1,n&&n.call(r.context,e)},o.backboneSync.apply(this,[i,s,r]);case"delete":return s.isNew()?!1:(r.dirty=!1,s.constructor.register().remove(s),o.backboneSync.apply(this,[i,s,r]));case"read":return r.dirty=!1,o.backboneSync.apply(this,[i,s,r])}else if(s instanceof e.Collection){var c=s;switch(i){case"read":var n=r.success;return r.remove=!1,r.success=function(e){r.dirty=!1;var t=r.reset?"reset":"set";c[t](e,r),n&&n.call(r.context,e)},o.backboneSync.apply(this,[i,c,r]);case"create":case"update":case"patch":r.success=r.originalSuccess,c.each(function(e){e.save(null,r)});break;case"delete":r.success=r.originalSuccess;var d=t.clone(c.models);t.each(d,function(e){e.destroy(r)})}}},m={client:v,server:b};o.setMode(m),o.setDefaultMode("server"),e.sync=p;var g=function(e,t){var i=t.error;t.error=function(s){i&&i.call(t.context,e,s,t),e.trigger("error",e,s,t)}}});