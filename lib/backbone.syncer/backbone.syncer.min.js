(function(t,e){if("function"==typeof define&&define.amd)define(["backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),s=require("underscore");module.exports=e(i,s)}else e(t.Backbone,t._)})(this,function(t,e){"use strict";function i(t,i){return e.isUndefined(t)?!1:e.isUndefined(i)?!0:t!==i}var s,r={backboneSync:t.sync,register:function(t,i){e.isObject(t)?e.extend(n,t):n[t]=i},unregister:function(t){delete n[t]},mode:function(t){return e.isFunction(t)?t:n[t]},defaultMode:function(t){return t?(s=t,void 0):s},reset:function(){n={}},VERSION:"0.1.0"},n={};t.Syncer=r,function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(s,r){return e.each(s,function(n,o){n instanceof t.Model||n instanceof t.Collection?s[o]=n.toJSON({deepJson:r}):e.isObject(n)&&r&&(s[o]=i(e.clone(n),r))}),s};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var s=arguments[1];s||(s={});var r;return e.isBoolean(s.omit)&&s.omit||e.isBoolean(s.pick)&&!s.pick?{}:(r=e.isBoolean(s.pick)&&s.pick||e.isBoolean(s.omit)&&!s.omit?t.call(this,s):s.pick?e.pick(this.attributes,s.pick):s.omit?e.omit(this.attributes,s.omit):t.call(this,s),r=i(r,s.deepJson))})}(t,e);var o=t.Model,c=t.Model.prototype.set,d=t.Model.prototype.fetch,u=t.Model.prototype.save,a=t.Model.prototype.destroy,l=t.Model.prototype.toJSON;t.Model=t.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==t.Model.prototype.initialize){var i=this,s=this.initialize;this.initialize=e.wrap(t.Model.prototype.initialize,function(t){t.apply(i,e.rest(arguments)),s.apply(i,e.rest(arguments))})}return o.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,e.extend(this.dirtied,e.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.register().add(this)},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return e.clone(this.dirtied)},hasDirtied:function(t){return null==t?!e.isEmpty(this.dirtied):e.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,s,r){if(null==t)return this;var n;"object"==typeof t?(n=t,r=s):(n={})[t]=s,r||(r={}),e.isUndefined(r.dirty)&&(r.dirty=!0);var o=c.call(this,n,r);if(r.dirty&&e.extend(this.dirtied,e.omit(n,[this.idAttribute,this.cidAttribute])),r&&r.version&&this.versionAttribute&&n[this.versionAttribute]){var d=this._previousAttributes[this.versionAttribute],u=n[this.versionAttribute];i(u,d)&&(this._fetched=!1,this.trigger("outdated",this,u,r))}return o},_destroyed:!1,isDestroyed:function(){return this._destroyed},fetch:function(t){return t||(t={}),e.defaults(t,{mode:r.defaultMode()}),d.apply(this,[t])},save:function(t,i,s){var n;return null==t||"object"==typeof t?(n=t,s=i):(n={})[t]=i,s||(s={}),e.defaults(s,{mode:r.defaultMode()}),s.changes=s.patch?n:e.extend(e.clone(this.attributes),n),u.apply(this,[n,s])},destroy:function(t){t||(t={}),e.defaults(t,{mode:r.defaultMode()});var i=this,s=t.success,n=t.wait;if(t.success=function(e){n&&(i._dirtyDestroyed=!0),s&&s.call(t.context,i,e,t)},n||(i._dirtyDestroyed=!0),this.isNew()){var o=function(){i.stopListening(),i.trigger("destroy",i,i.collection,t)};return t.success=function(e){n&&(i._dirtyDestroyed=!0),n&&o(),s&&s.call(t.context,i,e,t),i.isNew()||i.trigger("sync",i,e,t)},e.defer(t.success),n||o(),b(this,t),this.sync("delete",this,t)}return a.apply(this,[t])},pull:function(t){return t||(t={}),this.fetch(e.extend(t,{mode:"infinite"}))},push:function(t){if(t||(t={}),e.defaults(t,{mode:r.defaultMode()}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save(null,t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0},toJSON:function(t){var e=l.call(this,t);return t&&!t.cid&&delete e[this.cidAttribute],e}},{create:function(t,i){if(i||(i={}),i.idAttribute&&t[i.idAttribute]){var s=t[i.idAttribute];delete t[i.idAttribute],t[this.prototype.idAttribute]=s}if(i.cidAttribute&&t[i.cidAttribute]){var s=t[i.cidAttribute];delete t[i.cidAttribute],t[this.prototype.cidAttribute]=s}t&&t[this.prototype.idAttribute];var r=this.find(t);return r?t!==r.attributes?(r.set(r.parse(t),e.extend(i,{silent:!1})),r):(i.validate&&r._validate({},i),r):(i.parse=!0,new this(t,i))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.register().get(e||i)||!1},register:function(){if(!this._register){var e=this,i=t.Collection.extend({model:e}),s=this._register=new i;s.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&s.add(t,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),t.Collection.prototype.initialize,t.Collection.prototype.fetch,t.Collection=t.Collection.extend({idsUrl:function(t){return"/"+t.join(";")},fetch:function(t){t=e.extend({parse:!0},t),e.defaults(t,{mode:r.defaultMode()});var i=t.success,s=this;return t.success=function(e){i&&i.call(t.context,s,e,t),s.trigger("sync",s,e,t)},b(this,t),this.sync("read",this,t)},save:function(t){t||(t={}),e.defaults(t,{mode:r.defaultMode()});var i=t.success;t.originalSuccess=t.success;var s=this;return t.success=function(e){i&&i.call(t.context,s,e,t),s.trigger("sync",s,e,t)},this.sync("update",this,t)},destroy:function(t){t||(t={}),e.defaults(t,{mode:r.defaultMode()});var i=t.success;t.originalSuccess=t.success;var s=this;return t.success=function(e){i&&i.call(t.context,s,e,t),s.trigger("sync",s,e,t)},this.sync("delete",this,t)},pull:function(t){return t||(t={}),this.fetch(e.extend(t,{mode:"infinite"}))},push:function(t){var i=e.clone(this.models);e.each(i,function(e){e.push(t)})}});var f=function(t,e,i){i||(i={}),i.method=t;var s=i.mode;if(s){var n=r.mode(s);if(n)return n.apply(i.context,[t,e,i]);throw Error('The "mode" passed must be implemented.')}return r.backboneSync.apply(i.context,[t,e,i])},h=function(i,s,r){if(s instanceof t.Model)e.defer(r.success);else if(s instanceof t.Collection){r.success=r.originalSuccess;var n=s;switch(i){case"create":case"update":case"patch":n.each(function(t){t.save(null,r)});break;case"delete":n.each(function(t){t.destroy(r)})}}},p=function(i,s,r){if(s instanceof t.Model)switch(i){case"read":var n=r.success;return s.isFetched()?(e.defer(n),void 0):y.apply(this,[i,s,r])}else if(s instanceof t.Collection){var o=s;switch(i){case"read":var n=r.success;r.remove=!1;var c=o.filter(function(t){return!t.isNew()&&!t.isFetched()});if(e.isEmpty(c))return e.defer(n),void 0;var d=e.map(c,function(t){return t.id});return r.url=e.result(o,"url")+o.idsUrl(d),y.apply(this,[i,o,r])}}},y=function(i,s,n){if(s instanceof t.Model)switch(i){case"create":case"update":case"patch":var o=n.success;return n.success=function(t){n.dirty=!1,"create"===i&&(s._fetched=!0),e.each(n.changes,function(t,e){var i=s.dirtied[e];i===t&&delete s.dirtied[e]}),o&&o.call(n.context,t)},r.backboneSync.apply(this,[i,s,n]);case"delete":if(s.isNew())return!1;var o=n.success;return n.success=function(t){n.dirty=!1,s.constructor.register().remove(s),s._destroyed=!0,o&&o.call(n.context,t)},r.backboneSync.apply(this,[i,s,n]);case"read":var o=n.success;return n.success=function(t){n.dirty=!1,s._fetched=!0,o&&o.call(n.context,t)},r.backboneSync.apply(this,[i,s,n])}else if(s instanceof t.Collection){var c=s;switch(i){case"read":var o=n.success;return n.remove=!1,n.success=function(t){n.dirty=!1;var i=n.reset?"reset":"set";c[i](t,n);var s=t;e.each(s,function(t){var e=c.get(t);e._fetched=!0}),c.fetched=!0,o&&o.call(n.context,t)},r.backboneSync.apply(this,[i,c,n]);case"create":case"update":case"patch":n.success=n.originalSuccess,c.each(function(t){t.save(null,n)});break;case"delete":n.success=n.originalSuccess;var d=e.clone(c.models);e.each(d,function(t){t.destroy(n)})}}},v={client:h,infinite:p,server:y};r.register(v),r.defaultMode(y),t.sync=f;var b=function(t,e){var i=e.error;e.error=function(s){i&&i.call(e.context,t,s,e),t.trigger("error",t,s,e)}}});