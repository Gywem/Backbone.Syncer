(function(t,e){if("function"==typeof define&&define.amd)define(["locallyjs","backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore"),o=require("locallyjs");module.exports=e(o,i,r)}else e(t.Locally,t.Backbone,t._)})(this,function(t,e,i){"use strict";function r(t,e){return i.isUndefined(t)?!1:i.isUndefined(e)?!0:t!==e}function o(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function s(){return o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()}var n,c={backboneSync:e.sync,register:function(t,e){i.isObject(t)?i.extend(a,t):a[t]=e},unregister:function(t){delete a[t]},mode:function(t){return i.isFunction(t)?t:a[t]},defaultMode:function(t){return t?(n=t,void 0):n},reset:function(){a={}},VERSION:"0.1.0"},a={};e.Syncer=c,function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(r,o){return e.each(r,function(s,n){s instanceof t.Model||s instanceof t.Collection?r[n]=s.toJSON({deepJson:o}):e.isObject(s)&&o&&(r[n]=i(e.clone(s),o))}),r};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var r=arguments[1];r||(r={});var o;return e.isBoolean(r.omit)&&r.omit||e.isBoolean(r.pick)&&!r.pick?{}:(o=e.isBoolean(r.pick)&&r.pick||e.isBoolean(r.omit)&&!r.omit?t.call(this,r):r.pick?e.pick(this.attributes,r.pick):r.omit?e.omit(this.attributes,r.omit):t.call(this,r),o=i(o,r.deepJson))})}(e,i);var d=e.Model,l=e.Model.prototype.set,u=e.Model.prototype.fetch,h=e.Model.prototype.save,f=e.Model.prototype.destroy,p=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var t=this,r=this.initialize;this.initialize=i.wrap(e.Model.prototype.initialize,function(e){e.apply(t,i.rest(arguments)),r.apply(t,i.rest(arguments))})}return d.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,i.extend(this.dirtied,i.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.register().add(this)},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return i.clone(this.dirtied)},hasDirtied:function(t){return null==t?!i.isEmpty(this.dirtied):i.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,e,o){if(null==t)return this;var s;"object"==typeof t?(s=t,o=e):(s={})[t]=e,o||(o={}),i.isUndefined(o.dirty)&&(o.dirty=!0);var n=l.call(this,s,o);if(o.dirty&&i.extend(this.dirtied,i.omit(s,[this.idAttribute,this.cidAttribute])),o&&o.version&&this.versionAttribute&&s[this.versionAttribute]){var c=this._previousAttributes[this.versionAttribute],a=s[this.versionAttribute];r(a,c)&&(this._fetched=!1,this.trigger("outdated",this,a,o))}return n},_destroyed:!1,isDestroyed:function(){return this._destroyed},fetch:function(t){return t||(t={}),i.defaults(t,{mode:c.defaultMode()}),u.apply(this,[t])},save:function(t,e,r){var o;return null==t||"object"==typeof t?(o=t,r=e):(o={})[t]=e,r||(r={}),i.defaults(r,{mode:c.defaultMode()}),r.changes=r.patch?o:i.extend(i.clone(this.attributes),o),h.apply(this,[o,r])},destroy:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=this,r=t.success,o=t.wait;if(t.success=function(i){o&&(e._dirtyDestroyed=!0),r&&r.call(t.context,e,i,t)},o||(e._dirtyDestroyed=!0),this.isNew()){var s=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};return t.success=function(i){o&&(e._dirtyDestroyed=!0),o&&s(),r&&r.call(t.context,e,i,t),e.isNew()||e.trigger("sync",e,i,t)},i.defer(t.success),o||s(),S(this,t),this.sync("delete",this,t)}return f.apply(this,[t])},pull:function(t){return t||(t={}),i.defaults(t,{mode:c.defaultMode()}),this.isFetched()?(i.defer(t.success,this,void 0,t),void 0):this.fetch(t)},push:function(t){if(t||(t={}),i.defaults(t,{mode:c.defaultMode()}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save(null,t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0},toJSON:function(t){var e=p.call(this,t);return t&&!t.cid&&delete e[this.cidAttribute],e}},{create:function(t,e){if(e||(e={}),e.idAttribute&&t[e.idAttribute]){var r=t[e.idAttribute];delete t[e.idAttribute],t[this.prototype.idAttribute]=r}if(e.cidAttribute&&t[e.cidAttribute]){var r=t[e.cidAttribute];delete t[e.cidAttribute],t[this.prototype.cidAttribute]=r}t&&t[this.prototype.idAttribute];var o=this.find(t);return o?t!==o.attributes?(o.set(o.parse(t),i.extend(e,{silent:!1})),o):(e.validate&&o._validate({},e),o):(e.parse=!0,new this(t,e))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.register().get(e||i)||!1},register:function(){if(!this._register){var t=this,i=e.Collection.extend({model:t}),r=this._register=new i;r.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&r.add(t,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),e.Collection.prototype.initialize;var y=e.Collection.prototype.fetch;e.Collection=e.Collection.extend({idsUrl:function(t){return"/"+t.join(";")},fetch:function(t){return t=i.extend({parse:!0},t),i.defaults(t,{mode:c.defaultMode()}),y.apply(this,[t])},save:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=t.success;t.originalSuccess=t.success;var r=this;return t.success=function(i){var o=t.reset?"reset":"set";r[o](i,t),e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},this.sync("update",this,t)},destroy:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=t.success;t.originalSuccess=t.success;var r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},this.sync("delete",this,t)},pull:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=t.success;if(t.remove=!1,t.modelsToFetch=this.filter(function(t){return!t.isNew()&&!t.isFetched()}),i.isEmpty(t.modelsToFetch))return i.defer(e,this,void 0,t),void 0;var r=i.map(t.modelsToFetch,function(t){return t.id});return t.url=i.result(this,"url")+this.idsUrl(r),this.fetch(t)},push:function(t){var e=i.clone(this.models);i.each(e,function(e){e.push(t)})}});var v=function(t,e,i){i||(i={}),i.method=t;var r=i.mode;if(r){var o=c.mode(r);if(o)return o.apply(i.context,[t,e,i]);throw Error('The "mode" passed must be implemented.')}return c.backboneSync.apply(i.context,[t,e,i])},g=function(t,r,o){if(r instanceof e.Model)i.defer(o.success);else if(r instanceof e.Collection){o.success=o.originalSuccess;var s=r;switch(t){case"create":case"update":case"patch":s.each(function(t){t.save(null,o)});break;case"delete":s.each(function(t){t.destroy(o)})}}},m=function(t,r,o){if(r instanceof e.Model)switch(t){case"create":case"update":case"patch":var s=o.success;return o.success=function(e){o.dirty=!1,"create"===t&&(r._fetched=!0),i.each(o.changes,function(t,e){var i=r.dirtied[e];i===t&&delete r.dirtied[e]}),s&&s.call(o.context,e)},c.backboneSync.apply(this,[t,r,o]);case"delete":if(r.isNew())return!1;var s=o.success;return o.success=function(t){o.dirty=!1,r.constructor.register().remove(r),r._destroyed=!0,s&&s.call(o.context,t)},c.backboneSync.apply(this,[t,r,o]);case"read":var s=o.success;return o.success=function(t){o.dirty=!1,r._fetched=!0,s&&s.call(o.context,t)},c.backboneSync.apply(this,[t,r,o])}else if(r instanceof e.Collection){var n=r;switch(t){case"read":var s=o.success;return o.remove=!1,o.success=function(t){o.dirty=!1;var e=o.reset?"reset":"set";n[e](t,o);var r=t;i.each(r,function(t){var e=n.get(t);e._fetched=!0}),n.fetched=!0,s&&s.call(o.context,t)},c.backboneSync.apply(this,[t,n,o]);case"create":case"update":case"patch":o.success=o.originalSuccess,n.each(function(t){t.save(null,o)});break;case"delete":o.success=o.originalSuccess;var a=i.clone(n.models);i.each(a,function(t){t.destroy(o)})}}},b={client:g,server:m};c.register(b),c.defaultMode(m),e.sync=v;var S=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}};i.extend(e.Syncer,{storagePrefix:void 0,compressStorage:!1,storage:function(){return M()},serialKey:{attributes:0,dirtiedAttributes:1,dirtyDestroyed:2,changes:3,previousAttributes:4,fetched:5,destroyed:6,sid:7}});var A,x=e.Syncer.serialKey,M=function(){return A||(A=new t.Store({compress:e.Syncer.compressStorage})),A},k={};t.Store.prototype.setVersion=function(t){var e=M(),i=e.get("storageVersion");r(t,i)&&e.clear()};var _=function(t){this.model=t,this.localCache=t.constructor.register()};i.extend(_.prototype,{load:function(t){var e=M(),i=this.key(t),r=e.get(i);r&&(this.deserialize(r,t),this.localCache.add(this.model))},store:function(t){var e=M();this.model.sid&&this.model.id&&this.remove(t);var r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t))},remove:function(t){var e=M(),i=this.key(t);e.remove(i),delete this.model.sid,delete k[this.model.sid]},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.model,"storeName")||i.result(this.model.constructor,"storeName")||U(),s=this.model.sid||this.model.id||this.sid();return r+":"+o+":"+s},sid:function(){var t=s();return this.model.sid=t,k[t]=this.model[this.model.cidAttribute],t},serialize:function(t){var e={};e[x.attributes]=this.model.toJSON(i.extend({},t,{cid:!1})),e[x.dirtiedAttributes]=i.omit(this.model.dirtiedAttributes(),"cid"),e[x.dirtyDestroyed]=this.model.isDirtyDestroyed(),e[x.changes]=i.omit(this.model.changedAttributes(),"cid"),e[x.previousAttributes]=i.omit(this.model.previousAttributes(),"cid"),e[x.fetched]=this.model.isFetched(),e[x.destroyed]=this.model.isDestroyed();var r=this.model.sid;return r&&(e[x.sid]=r),e},deserialize:function(t,e){var r=t[x.sid];this.model.sid=r;var o=t[x.attributes];this.model.set(o,i.extend({},e,{localStorage:!1})),this.model.dirtied=t[x.dirtiedAttributes],this.model._dirtyDestroyed=t[x.dirtyDestroyed],this.model.changed=t[x.changes],this.model._previousAttributes=t[x.previousAttributes],this.model._fetched=t[x.fetched],this.model._destroyed=t[x.destroyed]}});var N=function(t){this.collection=t};i.extend(N.prototype,{load:function(t){var e=M(),i=this.key(t),r=e.get(i);r&&this.deserialize(r,t)},store:function(t){var e=M(),r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t)),this.collection.each(function(i){try{var r=i.storage().key();e.get(r)||i.storage().store(t)}catch(o){}},this)},remove:function(t){var e=M(),i=this.key(t);e.remove(i)},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.collection,"storeName")||U();return r+":"+o},serialize:function(t){var e=[];return this.collection.each(function(i){try{e.push(i.storage().key())}catch(r){e.push(i.storage().serialize(t))}},this),e},deserialize:function(t,e){var r=M(),o=[];for(var s in t){var n=t[s];if(i.isString(n)){var c,a,d=r.get(n);if(c=d[x.sid]){var l={};k[c]&&(l.cid=k[c]),a=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"})),a.sid=c,k[c]=a[a.cidAttribute]}else if(!i.isUndefined(d[x.attributes].id)){var l={};l.id=d[x.attributes].id,a=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"}))}if(!a)continue;a.storage().load()}else a=this.collection._prepareModel(n,e);o.push(a)}this.collection.set(o,i.extend({},e,{localStorage:!1}))}});var D=e.Model.prototype.constructor.register;i.extend(e.Model.prototype.constructor,{storeName:void 0,register:function(){var t=D.call(this);return t.storeName||(t.storeName=this.storeName+":register",t.on("update",function(t,e,i){i&&i.localStorage&&this.storage().store()},t)),t}}),e.Model.prototype.initialize;var w=e.Model.prototype.set,z=e.Model.prototype.fetch,J=e.Model.prototype.destroy,C=e.Model.prototype.pull;i.extend(e.Model.prototype,{storage:function(){return new _(this)},set:function(t,e,i){if(null==t)return i=e,i&&i.localStorage&&this.storage().store(i.localStorage),this;var r;"object"==typeof t?(r=t,i=e):(r={})[t]=e;var o=w.call(this,r,i);return i&&i.localStorage&&this.storage().store(i.localStorage),o},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),z.call(this,t)},destroy:function(t){var e=this,i=t.success,r=function(){t&&t.localStorage&&e.storage().remove(t.localStorage)},o=t.wait;return t.success=function(s){o&&r(),i&&i.call(t.context,e,s,t)},o||r(),J.call(this,t)},pull:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),C.call(this,t)}});var O=e.Collection.prototype.set,j=e.Collection.prototype.fetch,F=e.Collection.prototype.save,T=e.Collection.prototype.destroy,E=e.Collection.prototype.pull;i.extend(e.Collection.prototype,{storeName:void 0,storage:function(){return new N(this)},set:function(t,e){var i=O.call(this,t,e);return e&&e.localStorage&&this.storage().store(e.localStorage),i},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),j.call(this,t)},save:function(t){return t&&t.localStorage&&this.storage().store(t.localStorage),F.call(this,t)},destroy:function(t){return t&&t.localStorage&&this.storage().remove(t.localStorage),T.call(this,t)},pull:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),E.call(this,t)}});var U=function(){throw Error('An "storeName" property or function must be specified for storage')},B=function(t,e,r){var o=r.success;switch(t){case"create":case"update":case"patch":e.storage().store(r),o&&i.defer(o);break;case"delete":e.storage().remove(r),o&&i.defer(o);break;case"read":e.storage().load(r),o&&i.defer(o)}};c.register("localStorage",B)});