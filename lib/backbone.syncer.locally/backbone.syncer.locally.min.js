(function(t,e){if("function"==typeof define&&define.amd)define(["locallyjs","backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore"),s=require("locallyjs");module.exports=e(s,i,r)}else e(t.Locally,t.Backbone,t._)})(this,function(t,e,i){"use strict";function r(t,e){return i.isUndefined(t)?!1:i.isUndefined(e)?!0:t!==e}function s(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function o(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}var n,c={backboneSync:e.sync,register:function(t,e){i.isObject(t)?i.extend(a,t):a[t]=e},unregister:function(t){delete a[t]},mode:function(t){return i.isFunction(t)?t:a[t]},defaultMode:function(t){return t?(n=t,void 0):n},reset:function(){a={}},VERSION:"0.1.0"},a={};e.Syncer=c,function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(r,s){return e.each(r,function(o,n){o instanceof t.Model||o instanceof t.Collection?r[n]=o.toJSON({deepJson:s}):e.isObject(o)&&s&&(r[n]=i(e.clone(o),s))}),r};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var r=arguments[1];r||(r={});var s;return e.isBoolean(r.omit)&&r.omit||e.isBoolean(r.pick)&&!r.pick?{}:(s=e.isBoolean(r.pick)&&r.pick||e.isBoolean(r.omit)&&!r.omit?t.call(this,r):r.pick?e.pick(this.attributes,r.pick):r.omit?e.omit(this.attributes,r.omit):t.call(this,r),s=i(s,r.deepJson))})}(e,i);var d=e.Model,l=e.Model.prototype.set,u=e.Model.prototype.fetch,h=e.Model.prototype.save,f=e.Model.prototype.destroy,y=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var t=this,r=this.initialize;this.initialize=i.wrap(e.Model.prototype.initialize,function(e){e.apply(t,i.rest(arguments)),r.apply(t,i.rest(arguments))})}return d.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,i.extend(this.dirtied,i.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.register().add(this)},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return i.clone(this.dirtied)},hasDirtied:function(t){return null==t?!i.isEmpty(this.dirtied):i.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,e,s){if(null==t)return this;var o;"object"==typeof t?(o=t,s=e):(o={})[t]=e,s||(s={}),i.isUndefined(s.dirty)&&(s.dirty=!0);var n=l.call(this,o,s);if(s.dirty&&i.extend(this.dirtied,i.omit(o,[this.idAttribute,this.cidAttribute])),s&&s.version&&this.versionAttribute&&o[this.versionAttribute]){var c=this._previousAttributes[this.versionAttribute],a=o[this.versionAttribute];r(a,c)&&(this._fetched=!1,this.trigger("outdated",this,a,s))}return n},_destroyed:!1,isDestroyed:function(){return this._destroyed},fetch:function(t){return t||(t={}),i.defaults(t,{mode:c.defaultMode()}),u.apply(this,[t])},save:function(t,e,r){var s;return null==t||"object"==typeof t?(s=t,r=e):(s={})[t]=e,r||(r={}),i.defaults(r,{mode:c.defaultMode()}),r.changes=r.patch?s:i.extend(i.clone(this.attributes),s),h.apply(this,[s,r])},destroy:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=this,r=t.success,s=t.wait;if(t.success=function(i){s&&(e._dirtyDestroyed=!0),r&&r.call(t.context,e,i,t)},s||(e._dirtyDestroyed=!0),this.isNew()){var o=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};return t.success=function(i){s&&(e._dirtyDestroyed=!0),s&&o(),r&&r.call(t.context,e,i,t),e.isNew()||e.trigger("sync",e,i,t)},i.defer(t.success),s||o(),S(this,t),this.sync("delete",this,t)}return f.apply(this,[t])},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){if(t||(t={}),i.defaults(t,{mode:c.defaultMode()}),this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save(null,t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0},toJSON:function(t){var e=y.call(this,t);return t&&!t.cid&&delete e[this.cidAttribute],e}},{create:function(t,e){if(e||(e={}),e.idAttribute&&t[e.idAttribute]){var r=t[e.idAttribute];delete t[e.idAttribute],t[this.prototype.idAttribute]=r}if(e.cidAttribute&&t[e.cidAttribute]){var r=t[e.cidAttribute];delete t[e.cidAttribute],t[this.prototype.cidAttribute]=r}t&&t[this.prototype.idAttribute];var s=this.find(t);return s?t!==s.attributes?(s.set(s.parse(t),i.extend(e,{silent:!1})),s):(e.validate&&s._validate({},e),s):(e.parse=!0,new this(t,e))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.register().get(e||i)||!1},register:function(){if(!this._register){var t=this,i=e.Collection.extend({model:t}),r=this._register=new i;r.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&r.add(t,{silent:!0})})}return this._register},reset:function(){this.register().reset()}}),e.Collection.prototype.initialize,e.Collection.prototype.fetch,e.Collection=e.Collection.extend({idsUrl:function(t){return"/"+t.join(";")},fetch:function(t){t=i.extend({parse:!0},t),i.defaults(t,{mode:c.defaultMode()});var e=t.success,r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},S(this,t),this.sync("read",this,t)},save:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=t.success;t.originalSuccess=t.success;var r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},this.sync("update",this,t)},destroy:function(t){t||(t={}),i.defaults(t,{mode:c.defaultMode()});var e=t.success;t.originalSuccess=t.success;var r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},this.sync("delete",this,t)},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){var e=i.clone(this.models);i.each(e,function(e){e.push(t)})}});var p=function(t,e,i){i||(i={}),i.method=t;var r=i.mode;if(r){var s=c.mode(r);if(s)return s.apply(i.context,[t,e,i]);throw Error('The "mode" passed must be implemented.')}return c.backboneSync.apply(i.context,[t,e,i])},v=function(t,r,s){if(r instanceof e.Model)i.defer(s.success);else if(r instanceof e.Collection){s.success=s.originalSuccess;var o=r;switch(t){case"create":case"update":case"patch":o.each(function(t){t.save(null,s)});break;case"delete":o.each(function(t){t.destroy(s)})}}},g=function(t,r,s){if(r instanceof e.Model)switch(t){case"read":var o=s.success;return r.isFetched()?(i.defer(o),void 0):m.apply(this,[t,r,s])}else if(r instanceof e.Collection){var n=r;switch(t){case"read":var o=s.success;s.remove=!1;var c=n.filter(function(t){return!t.isNew()&&!t.isFetched()});if(i.isEmpty(c))return i.defer(o),void 0;var a=i.map(c,function(t){return t.id});return s.url=i.result(n,"url")+n.idsUrl(a),m.apply(this,[t,n,s])}}},m=function(t,r,s){if(r instanceof e.Model)switch(t){case"create":case"update":case"patch":var o=s.success;return s.success=function(e){s.dirty=!1,"create"===t&&(r._fetched=!0),i.each(s.changes,function(t,e){var i=r.dirtied[e];i===t&&delete r.dirtied[e]}),o&&o.call(s.context,e)},c.backboneSync.apply(this,[t,r,s]);case"delete":if(r.isNew())return!1;var o=s.success;return s.success=function(t){s.dirty=!1,r.constructor.register().remove(r),r._destroyed=!0,o&&o.call(s.context,t)},c.backboneSync.apply(this,[t,r,s]);case"read":var o=s.success;return s.success=function(t){s.dirty=!1,r._fetched=!0,o&&o.call(s.context,t)},c.backboneSync.apply(this,[t,r,s])}else if(r instanceof e.Collection){var n=r;switch(t){case"read":var o=s.success;return s.remove=!1,s.success=function(t){s.dirty=!1;var e=s.reset?"reset":"set";n[e](t,s);var r=t;i.each(r,function(t){var e=n.get(t);e._fetched=!0}),n.fetched=!0,o&&o.call(s.context,t)},c.backboneSync.apply(this,[t,n,s]);case"create":case"update":case"patch":s.success=s.originalSuccess,n.each(function(t){t.save(null,s)});break;case"delete":s.success=s.originalSuccess;var a=i.clone(n.models);i.each(a,function(t){t.destroy(s)})}}},b={client:v,infinite:g,server:m};c.register(b),c.defaultMode(m),e.sync=p;var S=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}};i.extend(e.Syncer,{storagePrefix:void 0,compressStorage:!1,storage:function(){return M()},serialKey:{attributes:0,dirtiedAttributes:1,dirtyDestroyed:2,changes:3,previousAttributes:4,fetched:5,destroyed:6,sid:7}});var x,A=e.Syncer.serialKey,M=function(){return x||(x=new t.Store({compress:e.Syncer.compressStorage})),x},k={};t.Store.prototype.setVersion=function(t){var e=M(),i=e.get("storageVersion");r(t,i)&&e.clear()};var _=function(t){this.model=t,this.localCache=t.constructor.register()};i.extend(_.prototype,{load:function(t){var e=M(),i=this.key(t),r=e.get(i);r&&(this.deserialize(r,t),this.localCache.add(this.model))},store:function(t){var e=M();this.model.sid&&this.model.id&&this.remove(t);var r=this.key(t),s=this.serialize(t);e.set(r,s,i.extend({},t))},remove:function(t){var e=M(),i=this.key(t);e.remove(i),delete this.model.sid,delete k[this.model.sid]},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,s=t.storeName||i.result(this.model,"storeName")||i.result(this.model.constructor,"storeName")||U(),o=this.model.sid||this.model.id||this.sid();return r+":"+s+":"+o},sid:function(){var t=o();return this.model.sid=t,k[t]=this.model[this.model.cidAttribute],t},serialize:function(t){var e={};e[A.attributes]=this.model.toJSON(i.extend({},t,{cid:!1})),e[A.dirtiedAttributes]=i.omit(this.model.dirtiedAttributes(),"cid"),e[A.dirtyDestroyed]=this.model.isDirtyDestroyed(),e[A.changes]=i.omit(this.model.changedAttributes(),"cid"),e[A.previousAttributes]=i.omit(this.model.previousAttributes(),"cid"),e[A.fetched]=this.model.isFetched(),e[A.destroyed]=this.model.isDestroyed();var r=this.model.sid;return r&&(e[A.sid]=r),e},deserialize:function(t,e){var r=t[A.sid];this.model.sid=r;var s=t[A.attributes];this.model.set(s,i.extend({},e,{localStorage:!1})),this.model.dirtied=t[A.dirtiedAttributes],this.model._dirtyDestroyed=t[A.dirtyDestroyed],this.model.changed=t[A.changes],this.model._previousAttributes=t[A.previousAttributes],this.model._fetched=t[A.fetched],this.model._destroyed=t[A.destroyed]}});var N=function(t){this.collection=t};i.extend(N.prototype,{load:function(t){var e=M(),i=this.key(t),r=e.get(i);r&&this.deserialize(r,t)},store:function(t){var e=M(),r=this.key(t),s=this.serialize(t);e.set(r,s,i.extend({},t)),this.collection.each(function(i){try{var r=i.storage().key();e.get(r)||i.storage().store(t)}catch(s){}},this)},remove:function(t){var e=M(),i=this.key(t);e.remove(i)},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,s=t.storeName||i.result(this.collection,"storeName")||U();return r+":"+s},serialize:function(t){var e=[];return this.collection.each(function(i){try{e.push(i.storage().key())}catch(r){e.push(i.storage().serialize(t))}},this),e},deserialize:function(t,e){var r=M(),s=[];for(var o in t){var n=t[o];if(i.isString(n)){var c,a,d=r.get(n);if(c=d[A.sid]){var l={};k[c]&&(l.cid=k[c]),a=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"})),a.sid=c,k[c]=a[a.cidAttribute]}else if(!i.isUndefined(d[A.attributes].id)){var l={};l.id=d[A.attributes].id,a=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"}))}if(!a)continue;a.storage().load()}else a=this.collection._prepareModel(n,e);s.push(a)}this.collection.set(s,i.extend({},e,{localStorage:!1}))}});var D=e.Model.prototype.constructor.register;i.extend(e.Model.prototype.constructor,{storeName:void 0,register:function(){var t=D.call(this);return t.storeName||(t.storeName=this.storeName+":register",t.on("update",function(t,e,i){i&&i.localStorage&&this.storage().store()},t)),t}}),e.Model.prototype.initialize;var w=e.Model.prototype.set,z=e.Model.prototype.fetch,J=e.Model.prototype.destroy;i.extend(e.Model.prototype,{storage:function(){return new _(this)},set:function(t,e,i){if(null==t)return i=e,i&&i.localStorage&&this.storage().store(i.localStorage),this;var r;"object"==typeof t?(r=t,i=e):(r={})[t]=e;var s=w.call(this,r,i);return i&&i.localStorage&&this.storage().store(i.localStorage),s},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),z.call(this,t)},destroy:function(t){var e=this,i=t.success,r=function(){t&&t.localStorage&&e.storage().remove(t.localStorage)},s=t.wait;return t.success=function(o){s&&r(),i&&i.call(t.context,e,o,t)},s||r(),J.call(this,t)}});var C=e.Collection.prototype.set,O=e.Collection.prototype.fetch,j=e.Collection.prototype.save,E=e.Collection.prototype.destroy;i.extend(e.Collection.prototype,{storeName:void 0,storage:function(){return new N(this)},set:function(t,e){var i=C.call(this,t,e);return e&&e.localStorage&&this.storage().store(e.localStorage),i},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),O.call(this,t)},save:function(t){return t&&t.localStorage&&this.storage().store(t.localStorage),j.call(this,t)},destroy:function(t){return t&&t.localStorage&&this.storage().remove(t.localStorage),E.call(this,t)}});var U=function(){throw Error('An "storeName" property or function must be specified for storage')},B=function(t,e,r){var s=r.success;switch(t){case"create":case"update":case"patch":e.storage().store(r),s&&i.defer(s);break;case"delete":e.storage().remove(r),s&&i.defer(s);break;case"read":e.storage().load(r),s&&i.defer(s)}};c.register("localStorage",B)});