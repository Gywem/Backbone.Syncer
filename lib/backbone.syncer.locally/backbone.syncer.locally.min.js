(function(t,e){if("function"==typeof define&&define.amd)define(["locallyjs","backbone","underscore"],e);else if("object"==typeof module&&module.exports){var i=require("backbone"),r=require("underscore"),o=require("locallyjs");module.exports=e(o,i,r)}else e(t.Locally,t.Backbone,t._)})(this,function(t,e,i){"use strict";function r(t,e){return i.isUndefined(t)?!1:i.isUndefined(e)?!0:t!==e}function o(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function s(){return o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()}var n={backboneSync:e.sync,syncMode:{},register:function(t,e){i.isObject(t)?i.extend(this.syncMode,t):this.syncMode[t]=e},unregister:function(t){i.isUndefined(t)?this.syncMode={}:delete this.syncMode[t]},ids_url_separator:"/",ids_separator:";",VERSION:"0.1.0"};e.Syncer=n,function(t,e){t.Jsonify={},t.Jsonify.VERSION="0.2.0",t.Jsonify.exToJSON=t.Model.prototype.toJSON;var i=function(r,o){return e.each(r,function(s,n){s instanceof t.Model||s instanceof t.Collection?r[n]=s.toJSON({deepJson:o}):e.isObject(s)&&o&&(r[n]=i(e.clone(s),o))}),r};t.Model.prototype.exToJSON=t.Jsonify.exToJSON,t.Model.prototype.toJSON=e.wrap(t.Jsonify.exToJSON,function(t){var r=arguments[1];r||(r={});var o;return e.isBoolean(r.omit)&&r.omit||e.isBoolean(r.pick)&&!r.pick?{}:(o=e.isBoolean(r.pick)&&r.pick||e.isBoolean(r.omit)&&!r.omit?t.call(this,r):r.pick?e.pick(this.attributes,r.pick):r.omit?e.omit(this.attributes,r.omit):t.call(this,r),o=i(o,r.deepJson))})}(e,i);var c=e.Model,d=e.Model.prototype.set,a=e.Model.prototype.fetch,l=e.Model.prototype.save,u=e.Model.prototype.destroy,h=e.Model.prototype.toJSON;e.Model=e.Model.extend({cidAttribute:"cid",constructor:function(){if(this.initialize!==e.Model.prototype.initialize){var t=this,r=this.initialize;this.initialize=i.wrap(e.Model.prototype.initialize,function(e){e.call(t,arguments[2]),r.call(t,arguments[2])})}return c.apply(this,arguments)},initialize:function(){this._fetched=!1,this.dirtied={},this._dirtyDestroyed=!1,this._destroyed=!1,i.extend(this.dirtied,i.omit(this.attributes,[this.idAttribute,this.cidAttribute])),this.set(this.cidAttribute,this.cid);var t=this.constructor;t.all().add(this)},versionAttribute:!1,_fetched:!1,isFetched:function(){return this._fetched},dirtied:{},dirtiedAttributes:function(){return i.clone(this.dirtied)},hasDirtied:function(t){return null==t?!i.isEmpty(this.dirtied):i.has(this.dirtied,t)},_dirtyDestroyed:!1,isDirtyDestroyed:function(){return this._dirtyDestroyed},clearDirtied:function(){this.dirtied={},this.dirtiedDestroyed=!1},set:function(t,e,o){if(null==t)return this;var s;"object"==typeof t?(s=t,o=e):(s={})[t]=e,o||(o={}),i.isUndefined(o.dirty)&&(o.dirty=!0);var n=d.call(this,s,o);if(o.dirty&&i.extend(this.dirtied,i.omit(s,[this.idAttribute,this.cidAttribute])),this.versionAttribute&&s[this.versionAttribute]){var c=this.previousAttributes()[this.versionAttribute],a=s[this.versionAttribute];o&&o.version&&r(a,c)&&(this._fetched=!1)}return n},_destroyed:!1,isDestroyed:function(){return this._destroyed},fetch:function(t){return t||(t={}),i.defaults(t,{mode:"server"}),a.apply(this,[t])},save:function(t,e,r){var o;return null==t||"object"==typeof t?(o=t,r=e):(o={})[t]=e,r||(r={}),i.defaults(r,{mode:"server"}),r.changes=r.patch?o:i.extend(i.clone(this.attributes),o),l.apply(this,[o,r])},destroy:function(t){t||(t={}),i.defaults(t,{mode:"server"});var e=this,r=t.success,o=t.wait;if(t.success=function(i){o&&(e._dirtyDestroyed=!0),r&&r.call(t.context,e,i,t)},o||(e._dirtyDestroyed=!0),this.isNew()){var s=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};return t.success=function(i){o&&(e._dirtyDestroyed=!0),o&&s(),r&&r.call(t.context,e,i,t),e.isNew()||e.trigger("sync",e,i,t)},i.defer(t.success),o||s(),g(this,t),this.sync("delete",this,t)}return u.apply(this,[t])},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var t=i.extend(t,{mode:"server"});if(this.isDirtyDestroyed()){if(this.isNew())return;return this.destroy(t)}return this.isNew()?this.save({},t):this.hasDirtied()?this.save(this.dirtiedAttributes(),t):void 0},toJSON:function(t){var e=h.call(this,t);return t&&!t.cid&&delete e[this.cidAttribute],e}},{create:function(t,e){if(e||(e={}),e.idAttribute&&t[e.idAttribute]){var r=t[e.idAttribute];delete t[e.idAttribute],t[this.prototype.idAttribute]=r}if(e.cidAttribute&&t[e.cidAttribute]){var r=t[e.cidAttribute];delete t[e.cidAttribute],t[this.prototype.cidAttribute]=r}t&&t[this.prototype.idAttribute];var o=this.find(t);return o?t!==o.attributes?(o.set(o.parse(t),i.extend(e,{silent:!1})),o):(e.validate&&o._validate({},e),o):(e.parse=!0,new this(t,e))},find:function(t){if(!t)return!1;var e=t[this.prototype.cidAttribute],i=t[this.prototype.idAttribute];return(e||i)&&this.all().get(e||i)||!1},all:function(){if(!this._all){var t=this,i=e.Collection.extend({model:t}),r=this._all=new i;r.on("destroy",function(t){t.isDirtyDestroyed()&&!t.isDestroyed()&&r.add(t,{silent:!0})})}return this._all},reset:function(){this.all().reset()}}),e.Collection.prototype.initialize;var f=e.Collection.prototype.fetch;e.Collection=e.Collection.extend({idsUrl:function(t){var r=i.result(this,"url")||S();return r+e.Syncer.ids_url_separator+t.join(e.Syncer.ids_separator)},fetch:function(t){t=i.extend({parse:!0},t),i.defaults(t,{mode:"server"});var e=t.success,r=this;return t.success=function(i){e&&e.call(t.context,r,i,t),r.trigger("sync",r,i,t)},g(this,t),this.sync("read",this,t)},save:function(t){t||(t={});var e=[];return this.each(function(i){var r=i.save([],t);e.push(r)}),e},destroy:function(t){t||(t={});var e=[],r=i.extend([],this.models);return i.each(r,function(i){var r=i.destroy(t);e.push(r)}),e},pull:function(t){return t||(t={}),this.fetch(i.extend(t,{mode:"infinite"}))},push:function(t){t||(t={});var e=[],r=i.extend([],this.models);return i.each(r,function(i){var r=i.push(t);e.push(r)}),e}});var y=function(t,e,i){i||(i={}),i.method=t;var r=i.mode;if(r){var o=n.syncMode[r];if(o)return o.apply(i.context,[t,e,i]);throw Error('The "mode" passed must be implemented.')}return n.backboneSync.apply(i.context,[t,e,i])},p=function(t,e,r){i.defer(r.success)},v=function(t,r,o){if(r instanceof e.Model)switch(t){case"read":var s=o.success;return r.isFetched()?(i.defer(s),void 0):m.apply(this,[t,r,o])}else if(r instanceof e.Collection){var n=r;switch(t){case"read":var s=o.success;o.remove=!1;var c=n.filter(function(t){return!t.isNew()&&!t.isFetched()});if(i.isEmpty(c))return i.defer(s),void 0;var d=i.map(c,function(t){return t.id});return o.url=n.idsUrl(d),m.apply(this,[t,n,o])}}},m=function(t,r,o){if(r instanceof e.Model)switch(t){case"create":case"update":case"patch":var s=o.success;return o.success=function(e){o.dirty=!1,"create"===t&&(r._fetched=!0),i.each(o.changes,function(t,e){var i=r.dirtied[e];i===t&&delete r.dirtied[e]}),s&&s.call(o.context,e)},n.backboneSync.apply(this,[t,r,o]);case"delete":if(r.isNew())return!1;var s=o.success;return o.success=function(t){o.dirty=!1,r.constructor.all().remove(r),r._destroyed=!0,s&&s.call(o.context,t)},n.backboneSync.apply(this,[t,r,o]);case"read":var s=o.success;return o.success=function(t){o.dirty=!1,r._fetched=!0,s&&s.call(o.context,t)},n.backboneSync.apply(this,[t,r,o])}else if(r instanceof e.Collection){var c=r;switch(t){case"read":var s=o.success;return o.remove=!1,o.success=function(t){o.dirty=!1;var e=o.reset?"reset":"set";c[e](t,o);var r=t;i.each(r,function(t){var e=c.get(t);e._fetched=!0}),c.fetched=!0,s&&s.call(o.context,t)},n.backboneSync.apply(this,[t,c,o])}}},b={client:p,infinite:v,server:m};n.register(b),e.sync=y;var g=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}},S=function(){throw Error('A "url" property or function must be specified')};i.extend(e.Syncer,{storagePrefix:void 0,compressStorage:!1,storage:function(){return _()},serialKey:{attributes:0,dirtiedAttributes:1,dirtyDestroyed:2,changes:3,previousAttributes:4,fetched:5,destroyed:6,sid:7}});var x,A=e.Syncer.serialKey,_=function(){return x||(x=new t.Store({compress:e.Syncer.compressStorage})),x},M={};t.Store.prototype.setVersion=function(t){var e=_(),i=e.get("storageVersion");r(t,i)&&e.clear()};var N=function(t){this.model=t,this.localCache=t.constructor.all()};i.extend(N.prototype,{load:function(t){var e=_(),i=this.key(t),r=e.get(i);r&&(this.deserialize(r,t),this.localCache.add(this.model))},store:function(t){var e=_();this.model.sid&&this.model.id&&this.remove(t);var r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t))},remove:function(t){var e=_(),i=this.key(t);e.remove(i),delete this.model.sid,delete M[this.model.sid]},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.model,"storeName")||i.result(this.model.constructor,"storeName")||E(),s=this.model.sid||this.model.id||this.sid();return r+":"+o+":"+s},sid:function(){var t=s();return this.model.sid=t,M[t]=this.model[this.model.cidAttribute],t},serialize:function(t){var e={};e[A.attributes]=this.model.toJSON(i.extend({},t,{cid:!1})),e[A.dirtiedAttributes]=i.omit(this.model.dirtiedAttributes(),"cid"),e[A.dirtyDestroyed]=this.model.isDirtyDestroyed(),e[A.changes]=i.omit(this.model.changedAttributes(),"cid"),e[A.previousAttributes]=i.omit(this.model.previousAttributes(),"cid"),e[A.fetched]=this.model.isFetched(),e[A.destroyed]=this.model.isDestroyed();var r=this.model.sid;return r&&(e[A.sid]=r),e},deserialize:function(t,e){var r=t[A.sid];this.model.sid=r;var o=t[A.attributes];this.model.set(o,i.extend({},e,{localStorage:!1})),this.model.dirtied=t[A.dirtiedAttributes],this.model._dirtyDestroyed=t[A.dirtyDestroyed],this.model.changed=t[A.changes],this.model._previousAttributes=t[A.previousAttributes],this.model._fetched=t[A.fetched],this.model._destroyed=t[A.destroyed]}});var k=function(t){this.collection=t};i.extend(k.prototype,{load:function(t){var e=_(),i=this.key(t),r=e.get(i);r&&this.deserialize(r,t)},store:function(t){var e=_(),r=this.key(t),o=this.serialize(t);e.set(r,o,i.extend({},t)),this.collection.each(function(i){try{var r=i.storage().key();e.get(r)||i.storage().store(t)}catch(o){}},this)},remove:function(t){var e=_(),i=this.key(t);e.remove(i)},key:function(t){t||(t={});var r=e.Syncer.storagePrefix,o=t.storeName||i.result(this.collection,"storeName")||E();return r+":"+o},serialize:function(t){var e=[];return this.collection.each(function(i){try{e.push(i.storage().key())}catch(r){e.push(i.storage().serialize(t))}},this),e},deserialize:function(t,e){var r=_(),o=[];for(var s in t){var n=t[s];if(i.isString(n)){var c,d,a=r.get(n);if(c=a[A.sid]){var l={};M[c]&&(l.cid=M[c]),d=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"})),d.sid=c,M[c]=d[d.cidAttribute]}else if(!i.isUndefined(a[A.attributes].id)){var l={};l.id=a[A.attributes].id,d=this.collection._prepareModel(l,i.extend({},e,{idAttribute:"id",cidAttribute:"cid"}))}if(!d)continue;d.storage().load()}else d=this.collection._prepareModel(n,e);o.push(d)}this.collection.set(o,i.extend({},e,{localStorage:!1}))}});var D=e.Model.prototype.constructor.all;i.extend(e.Model.prototype.constructor,{storeName:void 0,all:function(){var t=D.call(this);return t.storeName||(t.storeName=this.storeName+":all",t.on("update",function(t,e,i){i&&i.localStorage&&this.storage().store()},t)),t}});var w=e.Model.prototype.initialize,z=e.Model.prototype.set,J=e.Model.prototype.fetch;i.extend(e.Model.prototype,{storage:function(){return new N(this)},initialize:function(t){w.call(this,t),this.on("destroy",function(t,e,i){i&&i.localStorage&&this.storage().remove(i.localStorage)},this)},set:function(t,e,i){if(null==t)return i=e,i&&i.localStorage&&this.storage().store(i.localStorage),this;var r;"object"==typeof t?(r=t,i=e):(r={})[t]=e;var o=z.call(this,r,i);return i&&i.localStorage&&this.storage().store(i.localStorage),o},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),J.call(this,t)}});var C=e.Collection.prototype.set,f=e.Collection.prototype.fetch,O=e.Collection.prototype.save,j=e.Collection.prototype.destroy;i.extend(e.Collection.prototype,{storeName:void 0,storage:function(){return new k(this)},set:function(t,e){var i=C.call(this,t,e);return e&&e.localStorage&&this.storage().store(e.localStorage),i},fetch:function(t){return t&&t.localStorage&&this.storage().load(t.localStorage),f.call(this,t)},save:function(t){return t&&t.localStorage&&this.storage().store(t.localStorage),O.call(this,t)},destroy:function(t){return t&&t.localStorage&&this.storage().remove(t.localStorage),j.call(this,t)}});var E=function(){throw Error('An "storeName" property or function must be specified for storage')}});